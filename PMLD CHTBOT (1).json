{
  "name": "PMLD CHTBOT (1)",
  "nodes": [
    {
      "parameters": {
        "content": "## Flow Login Akun Robota\n",
        "height": 784,
        "width": 3040,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -9248,
        -3968
      ],
      "typeVersion": 1,
      "id": "46e0c1f0-cd58-4bf3-956b-4a5b65f7fd05",
      "name": "Sticky Note3",
      "disabled": true
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "bb84d563-42c8-4005-ae97-2f9cce88442a",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -5584,
        -3328
      ],
      "id": "ba1a234d-515c-46fd-81de-b7eebcccdda2",
      "name": "Login Via Web1",
      "webhookId": "bb84d563-42c8-4005-ae97-2f9cce88442a",
      "disabled": true
    },
    {
      "parameters": {
        "content": "## Flow Utama Chatbot"
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -6800,
        -1248
      ],
      "typeVersion": 1,
      "id": "667ab57f-4c35-4967-a072-30b6930a8bd5",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "text": "={{ $('Telegram Trigger Chatbot1').item.json.message.text }}",
        "schemaType": "fromJson",
        "jsonSchemaExample": "{\n\t\"start_date\": \"2025-06-01\",\n    \"end_date\": \"2025-06-31\",\n\t\"ota\": \"agoda\",\n  \"sentiment\" : \"postive\",\n  \"categories\": \"kebersihan\",\n  \"response\": false,\n  \"require_reviews\": true,\n  \"require_hotel_data\": false,\n  \"out_of_topic\": false\n}",
        "options": {
          "systemPromptTemplate": "=Anda ditugaskan mengambil informasi penting dari seorang pengguna website robota (dashboard integrasi berbagai ota hotel) yang ingin menaganalisis data terkait hotel, dan reviews. Dapatkan hal penting seperti:\n1. start_date (format: 2025-08-01),\n2. end_date (format: 2025-08-01),\n3. ota (wajib satu jenis, jika ada lebih dari 1 \"all\"),\n4. sentiment\n5. categories (wajib satu jenis, jika ada lebih dari 1 \"all\"),\n6. response (review sudah dibalas atau belum)\n7. require_reviews (apakah membutuhkan data reviews): jawab true atau false\n8. require_hotel_data (apakah membutuhkan data hotel): jawab true atau false\n9. out of topic (true ketika tidak membahas hotel dan reviews hotel)\n\nPenting! \n- jika mengacu pada hari ini, minggu ini, tahun ini. Gunakan data ini {{$today}}\n- jika tidak disebutkan spesifik tanggal, gunakan tanggal bulan ini",
          "batching": {
            "batchSize": 1
          }
        }
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1.2,
      "position": [
        -3120,
        -3712
      ],
      "id": "e86c3485-03eb-4afb-87b1-fa86262dd2e5",
      "name": "Information Extractor1",
      "disabled": true
    },
    {
      "parameters": {
        "modelName": "models/gemini-flash-lite-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -3104,
        -3456
      ],
      "id": "b05ea97f-c2c0-4ea3-a78f-a4c38e5e549a",
      "name": "Google Gemini Chat Model6",
      "credentials": {
        "googlePalmApi": {
          "id": "0Uoi9vQ15TeiYabQ",
          "name": "Google Gemini(PaLM) Api account Chatbot"
        }
      },
      "disabled": true
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -2624,
        -3360
      ],
      "id": "bdcda115-025d-4035-8062-5a5c093b8eb7",
      "name": "No Operation, do nothing1",
      "disabled": true
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        -5152,
        -4032
      ],
      "id": "57541fe7-d57d-4082-802a-13402ad9aa99",
      "name": "Telegram Trigger Chatbot1",
      "webhookId": "66eed568-f3ea-49de-bd6c-d64d08820be4",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "user",
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_chat_id",
              "keyValue": "={{ $('Telegram Trigger Chatbot1').item.json.message.chat.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4320,
        -3808
      ],
      "id": "0cdcf441-ffe9-4cb6-a9d8-3f2f417bfa0a",
      "name": "Supabase - Get Data User1",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "tux4n9M75BJM11U2",
          "name": "Supabase main"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b96b8ef5-ae03-4cb7-b53a-8b08789b99ef",
              "leftValue": "={{ $json}}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4112,
        -3776
      ],
      "id": "8adc4c94-9641-4283-b8b3-6c1638ccbf16",
      "name": "User Data in Database?1",
      "alwaysOutputData": false,
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b72f681c-c8db-4f4b-bf83-e95d6b794a0a",
              "leftValue": "={{ $('User Data in Database?1').item.json.token_api }}",
              "rightValue": "401",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3584,
        -3808
      ],
      "id": "78429469-c7f6-4012-8071-a96776ac62c8",
      "name": "is Login Robota Account?1",
      "disabled": true
    },
    {
      "parameters": {
        "tableId": "user",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "telegram_chat_id",
              "fieldValue": "={{ $('Telegram Trigger Chatbot1').item.json.message.chat.id }}"
            },
            {
              "fieldId": "telegram_username",
              "fieldValue": "={{ $('Telegram Trigger Chatbot1').item.json.message.chat.username }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $now }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3536,
        -3488
      ],
      "id": "c2e17608-2779-4a32-b716-93f40714b90e",
      "name": "Supabase - Create User1",
      "credentials": {
        "supabaseApi": {
          "id": "tux4n9M75BJM11U2",
          "name": "Supabase main"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger Chatbot1').item.json.message.chat.id }}",
        "text": "Silahkan login terlebih dahulu",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "Login",
                    "additionalFields": {
                      "url": "={{ \"https://authclerk-n8n.vercel.app/login?tele_id=\" + $('Telegram Trigger Chatbot1').item.json.message.chat.id}}"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3280,
        -3504
      ],
      "id": "5b6cfcc4-f652-4b12-9707-78070819f788",
      "name": "Send Messages - Login First1",
      "webhookId": "06bae668-eac7-463b-b9ee-a2de130dfbf8",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "42705b58-043b-4232-bb5f-f7390db4370a",
                    "leftValue": "={{ $json.output.out_of_topic }}",
                    "rightValue": "={{ $json.output.out_of_topic }}",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "out of topic"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.output.require_reviews }}",
                    "rightValue": "true",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    },
                    "id": "cff7bcf5-cf43-426e-84b6-a09ddc49c8aa"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "reviews data"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "037f54be-235b-4a95-a53b-5fe7ea6e3aaf",
                    "leftValue": "={{ $json.output.require_hotel_data }}",
                    "rightValue": "",
                    "operator": {
                      "type": "boolean",
                      "operation": "true",
                      "singleValue": true
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "hotel data"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -2816,
        -3728
      ],
      "id": "0f78a992-fb1c-457a-857d-bb2a0e77b4ca",
      "name": "Switch For Relevant Data1",
      "disabled": true
    },
    {
      "parameters": {
        "url": "https://api.robota.app/v1.1/analyst/reviews",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "start_date",
              "value": "={{ $json.output.start_date }}"
            },
            {
              "name": "end_date",
              "value": "={{ $json.output.end_date }}"
            },
            {
              "name": "ota",
              "value": "={{ $json.output.ota != \"all\" ? $json.output.ota : '' }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2624,
        -4032
      ],
      "id": "46d0dcfe-29f3-4f3a-badb-32a0610271fe",
      "name": "API Robota - Get Data Reviews2",
      "credentials": {
        "httpBearerAuth": {
          "id": "8kjO2ahoIEKPnKGR",
          "name": "Bearer Auth account 2"
        }
      },
      "disabled": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user",
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_chat_id",
              "condition": "eq",
              "keyValue": "={{ $('Supabase - Get Data User1').item.json.telegram_chat_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "token_api",
              "fieldValue": "={{ $json.data.access_token }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2032,
        -3888
      ],
      "id": "511acfc5-947d-4a5d-91ec-2df65621f269",
      "name": "Supabase - Update a token_api1",
      "credentials": {
        "supabaseApi": {
          "id": "tux4n9M75BJM11U2",
          "name": "Supabase main"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "url": "https://api.robota.app/v1.1/analyst/reviews",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "start_date",
              "value": "={{ $('Information Extractor1').item.json.output.start_date }}"
            },
            {
              "name": "end_date",
              "value": "={{ $('Information Extractor1').item.json.output.end_date }}"
            },
            {
              "name": "ota",
              "value": "={{ $('Information Extractor1').item.json.output.ota != \"all\" ? $('Information Extractor1').item.json.output.ota : '' }}"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -1808,
        -3888
      ],
      "id": "9e39f618-210d-41b2-9d98-02387d3c7725",
      "name": "API Robota - Get Data Reviews ",
      "credentials": {
        "httpBearerAuth": {
          "id": "wBNagN4GUC0Iib2o",
          "name": "Bearer Auth account 2"
        }
      },
      "disabled": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.robota.app/v1.1/auth/login",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n\t\"email\": \"{{ $json.body.email }}\",\n\t\"password\": \"{{ $json.body.password }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -5376,
        -3328
      ],
      "id": "d1ff90bd-3351-4d4e-b77c-c9c2dcef1965",
      "name": "API Robota - Login User1",
      "alwaysOutputData": false,
      "disabled": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "chatId": "={{ $('Login Via Web1').item.json.body.tele_id }}",
        "text": "Mohon maaf anda gagal login",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -5056,
        -3184
      ],
      "id": "63f55a7c-f975-4b84-b82d-5f3cd00eef04",
      "name": "Send a Message - Failed Login1",
      "webhookId": "35dd8484-8c36-45fa-93a6-a20bdfdf89f1",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "={{ $json.telegram_chat_id }}",
        "text": "={{`Selamat Datang ${$json.telegram_username}, Anda sudah berhasil login. Saya chatbot robota ada yang bisa saya bantu?\n\nUntuk mengatur jadwal notifikasi, gunakan:\n/notifikasi [mingguan/bulanan] [hari/tanggal] [jam]\n\nUntuk mengambil rangkuman, gunakan:`}}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4768,
        -3392
      ],
      "id": "682de8fb-63a9-4823-9ebb-c563ff22861f",
      "name": "Send a Message - Login Succesfully1",
      "webhookId": "41515003-de20-47b1-83c8-94c230f2ae76",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.robota.app/v1.1/auth/refresh-token",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -2288,
        -3888
      ],
      "id": "519297a6-c738-4d6e-9a03-3a5e9a018199",
      "name": "API Robota - Refresh Token (if token expired)1",
      "credentials": {
        "httpBearerAuth": {
          "id": "w3wQYmtwy1SX81CR",
          "name": "Ambil Refresh Token"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user",
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_chat_id",
              "condition": "eq",
              "keyValue": "={{ $('Login Via Web1').item.json.body.tele_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "token_api",
              "fieldValue": "={{ $json.data.access_token }}"
            },
            {
              "fieldId": "refresh_token",
              "fieldValue": "={{ $json.data.refresh_token }}"
            },
            {
              "fieldId": "email",
              "fieldValue": "={{ $json.data.user.email }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5040,
        -3392
      ],
      "id": "777dac66-d2fc-49e8-b74d-e72da85ec9fd",
      "name": "Supabase - Add a user token_api1",
      "credentials": {
        "supabaseApi": {
          "id": "tux4n9M75BJM11U2",
          "name": "Supabase main"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -5712,
        -3984
      ],
      "id": "91857d53-ed85-4e1c-a4dd-c73f980b9025",
      "name": "Telegram Trigger5",
      "webhookId": "555aea85-2b44-4a67-b30e-29d4e4317a7d",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/notifikasi",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    },
                    "id": "276d5614-c709-4530-8058-99ce42d4ced3"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "notifikasi"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fb6b1455-e6ff-4791-ac6c-0aafd13b284f",
                    "leftValue": "={{ $json.message.text }}",
                    "rightValue": "/",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "/"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra",
          "renameFallbackOutput": "=Flow utama"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -4832,
        -4032
      ],
      "id": "8baf49df-d308-44a7-840f-1de76df3b5f2",
      "name": "Switch Config1",
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "={{ $json.message.chat.id }}",
        "text": "Tidaak ada perintah yang cocok,  Silahkan ulangi",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3872,
        -4032
      ],
      "id": "bcb7dd03-d90b-42ef-9f9d-3c7eaea7e0fd",
      "name": "Send a text message11",
      "webhookId": "a107e898-4817-4202-a0f5-a8cfad96dadc",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f254e4d0-31e8-4917-af57-0b46b81e32ee",
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3456,
        -4384
      ],
      "id": "aef58905-f67d-472e-8bbe-c32b67d9e717",
      "name": "If5",
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger3').item.json.message.chat.id }}\nContoh format perintah yang benar:\n/notifikasi mingguan senin(ubah dengan hari yang diinginkan) 19(ubah dengan pukul yang diinginkan)\n/notifikasi bulanan 25(ubah dengan tanggal yang diinginkan) 15(ubah dengan pukul yang diinginkan)",
        "text": "={{ $json.error }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3232,
        -4256
      ],
      "id": "05abd50b-115c-4a07-9723-a199f90b412b",
      "name": "Send a text message16",
      "webhookId": "54d5fa02-0c6f-491b-a2b9-9900967f19f8",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.schedule_type }}",
                    "rightValue": "mingguan",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "21cbeb64-6577-4f0e-ad49-5cca9eca2983"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mingguan"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "71853b52-ad5d-4a5d-92b2-8a71752b1cce",
                    "leftValue": "={{ $json.schedule_type }}",
                    "rightValue": "bulanan",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "bulanan"
            }
          ]
        },
        "options": {
          "allMatchingOutputs": false
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3248,
        -4480
      ],
      "id": "fd4fd682-bdd3-4865-9745-d4e9b81c45fa",
      "name": "Switch",
      "alwaysOutputData": false,
      "disabled": true
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user",
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_chat_id",
              "condition": "eq",
              "keyValue": "={{ $('Telegram Trigger5').item.json.message.chat.id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "schedule",
              "fieldValue": "={{ $json.schedule_type }}"
            },
            {
              "fieldId": "date",
              "fieldValue": "={{ $json.schedule_date }}"
            },
            {
              "fieldId": "time",
              "fieldValue": "={{ $json.schedule_hour }}"
            },
            {
              "fieldId": "day",
              "fieldValue": "="
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2912,
        -4384
      ],
      "id": "1f5081c9-f6b3-4666-b2f6-ba32c5ef01f2",
      "name": "Update a row5",
      "credentials": {
        "supabaseApi": {
          "id": "tux4n9M75BJM11U2",
          "name": "Supabase main"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "={{ $json.telegram_chat_id }}",
        "text": "=Selamat, pengaturan notifikasi {{ $json.schedule }} anda telah diperbarui!\n\nJadwal: {{ $json.schedule }}\nDikirim setiap tanggal: {{ $json.date }}\nPukul: {{ $json.time }}:00",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2704,
        -4384
      ],
      "id": "c269a65a-b0fe-4185-8784-55ae9577b3bf",
      "name": "Send a text message17",
      "webhookId": "2c8659bb-34e9-4d58-aec6-3ce6921a5a94",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Ambil seluruh teks pesan, contoh: \"/notifikasi mingguan senin 10\"\nconst text = $input.item.json.message.text;\n\n// Pecah teks berdasarkan spasi menjadi beberapa bagian\n// -> [\"/notifikasi\", \"mingguan\", \"senin\", \"10\"]\nconst parts = text.split(' ');\n\nconst result = {};\n\n// Cek apakah formatnya benar (harus ada 4 bagian)\nif (parts.length !== 4) {\n  result.error = \"Format perintah salah. Gunakan: /notifikasi [mingguan/bulanan] [hari/tanggal] [jam]\";\n  return [{ json: result }];\n}\n\nconst type = parts[1].toLowerCase();\nconst value = parts[2].toLowerCase();\nconst hour = parseInt(parts[3], 10);\n\nresult.schedule_type = type;\nresult.schedule_hour = hour;\n\nif (type === 'mingguan') {\n  // Buat daftar hari yang valid\n  const validDays = ['senin', 'selasa', 'rabu', 'kamis', 'jumat', 'sabtu', 'minggu'];\n  \n  // Cek apakah hari yang dimasukkan ada di dalam daftar\n  if (validDays.includes(value)) {\n    result.schedule_day = value; // Simpan nama harinya langsung\n  } else {\n    result.schedule_day = null;\n    result.error = \"Nama hari salah. Gunakan: senin, selasa, rabu, kamis, jumat, sabtu, atau minggu.\";\n  }\n} else if (type === 'bulanan') {\n  result.schedule_date = parseInt(value, 10); // Ambil tanggalnya\n  if (isNaN(result.schedule_date) || result.schedule_date < 1 || result.schedule_date > 31) {\n      result.error = \"Format tanggal salah. Gunakan angka 1-31.\";\n  }\n} else {\n  result.error = \"Tipe jadwal salah. Pilih 'mingguan' atau 'bulanan'.\";\n}\n\n// Cek jika jam tidak valid\nif (isNaN(hour) || hour < 0 || hour > 23) {\n    result.error = \"Format jam salah. Gunakan angka 0-23.\";\n}\n\nreturn [{ json: result }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3664,
        -4384
      ],
      "id": "fc60f9c9-18a5-45c8-a938-6cd1811a5139",
      "name": "Code5",
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8c287a0a-e728-49be-ba07-5f68234edc45",
              "leftValue": "={{ $json.schedule }}",
              "rightValue": "mingguan",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "63ebd0e0-2ee8-4209-ae29-d4d7bfbef859",
              "leftValue": "={{ $json.time.toString() }}",
              "rightValue": "={{ $now.setZone('Asia/Jakarta').toFormat('H') }}",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5712,
        -3824
      ],
      "id": "500394ff-2406-4021-81d1-edf793109971",
      "name": "Time is OK & Weekly2",
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "={{$('Telegram Trigger Chatbot1').item.json.message.chat.id }}\n",
        "text": "‚è≥ Sedang menganalisis review Anda...",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4576,
        -3872
      ],
      "id": "8d894c05-2279-439e-a76c-43e27d57c7e4",
      "name": "Send a text message",
      "webhookId": "915256f3-2467-4c7b-94b3-641786d9b565",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Send a text message').item.json.result.chat.id }}",
        "messageId": "={{ $('Send a text message').item.json.result.message_id }}",
        "text": "üîë Sedang mengecek Anda apakah sudah melakukan login atau belum",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3904,
        -3872
      ],
      "id": "9a11e35b-e6d7-456c-96ed-2999f77641b3",
      "name": "Edit a text message",
      "webhookId": "4a32a373-53e2-4c6a-9625-58d1b63f0dce",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "return {\n\t\"data\": [\n\t\t{\n\t\t\t\"review\": {\n\t\t\t\t\"url\": \"https://www.tripadvisor.co.id/ShowUserReviews-g14782503-d15067692-r982445091-Horison_Emerald_Timoho_Yogyakarta-Yogyakarta_Yogyakarta_Region_Java.html#review982445091\",\n\t\t\t\t\"title\": \"Hotel 4 Jogja\",\n\t\t\t\t\"rating\": \"5\",\n\t\t\t\t\"date\": \"2024-11-27T20:27:07-05:00\",\n\t\t\t\t\"language\": \"Indonesian\",\n\t\t\t\t\"id\": \"982445091\",\n\t\t\t\t\"message\": \"Saya baru saja menginap di @HOM Premier Timoho selama beberapa malam, dan saya sangat terkesan dengan pelayanan serta fasilitas yang disediakan. Dari saat tiba, staf hotel sangat ramah dan membantu, proses check-in berjalan sangat lancar. Kamar yang saya tempati sangat bersih, nyaman, dan dilengkapi dengan berbagai fasilitas modern seperti Wi-Fi cepat, TV layar datar, dan minibar yang lengkap. Pemandangan dari jendela kamar juga sangat menakjubkan, memberikan suasana yang sangat menyenangkan. Selain itu, lokasi hotel sangat strategis, dekat dengan berbagai tempat wisata dan restoran yang enak. Saya juga menikmati sarapan pagi yang bervariasi dan lezat, dengan pilihan menu yang memadai untuk berbagai selera. Secara keseluruhan, saya merasa sangat puas dengan pengalaman menginap di [Nama Hotel] dan pasti akan kembali lagi di masa depan. Sangat direkomendasikan bagi siapa saja yang mencari tempat menginap yang nyaman dengan layanan terbaik!\",\n\t\t\t\t\"rating_normalization\": {\n\t\t\t\t\t\"normal\": 10,\n\t\t\t\t\t\"original\": 5\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"user\": {\n\t\t\t\t\"id\": \"246ED2F139EAC5FED7E4CE92A944821B\",\n\t\t\t\t\"name\": \"Sherpa27006182110\"\n\t\t\t},\n\t\t\t\"source\": \"tripadvisor\",\n\t\t\t\"last_access\": \"2024-11-28T15:26:24.766597\",\n\t\t\t\"sentiment\": {\n\t\t\t\t\"meal\": \"positive\",\n\t\t\t\t\"surrounding\": \"positive\",\n\t\t\t\t\"service\": \"positive\",\n\t\t\t\t\"location\": \"positive\",\n\t\t\t\t\"staff\": \"positive\",\n\t\t\t\t\"facility\": \"positive\",\n\t\t\t\t\"value\": \"\",\n\t\t\t\t\"room\": \"positive\",\n\t\t\t\t\"quality\": \"positive\"\n\t\t\t},\n\t\t\t\"sentiment_general\": \"Positive\"\n\t\t},\n\t\t{\n\t\t\t\"review\": {\n\t\t\t\t\"url\": \"https://www.traveloka.com/en-id/user/review/detail/HOTEL/1816834096853170568\",\n\t\t\t\t\"title\": \"\",\n\t\t\t\t\"rating\": \"9.4\",\n\t\t\t\t\"date\": \"2024-11-27T00:40:15.340000\",\n\t\t\t\t\"language\": \"English\",\n\t\t\t\t\"id\": \"1816834096853170568\",\n\t\t\t\t\"message\": \"First time staying here, the service is very good, the staff is friendly, check in before 2 pm is served. I lost my motorbike key after checking out and was helped to find it, it turned out that it had been secured by the security guard. The room is okay, comfortable, only the bed sheet has quite a lot of ink stains and a few blood-like stains, it should be noted again. Fast wifi, breakfast is okay although not much variety.\",\n\t\t\t\t\"rating_normalization\": {\n\t\t\t\t\t\"normal\": 9.4,\n\t\t\t\t\t\"original\": 9.4\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"user\": {\n\t\t\t\t\"id\": null,\n\t\t\t\t\"name\": \"W***a\"\n\t\t\t},\n\t\t\t\"source\": \"traveloka\",\n\t\t\t\"last_access\": \"2024-11-29T14:00:32.161075\",\n\t\t\t\"sentiment\": {\n\t\t\t\t\"meal\": \"neutral\",\n\t\t\t\t\"surrounding\": \"neutral\",\n\t\t\t\t\"service\": \"positive\",\n\t\t\t\t\"location\": \"neutral\",\n\t\t\t\t\"staff\": \"positive\",\n\t\t\t\t\"facility\": \"neutral\",\n\t\t\t\t\"value\": \"neutral\",\n\t\t\t\t\"room\": \"neutral\",\n\t\t\t\t\"quality\": \"neutral\"\n\t\t\t},\n\t\t\t\"sentiment_general\": \"Positive\"\n\t\t},\n\t\t{\n\t\t\t\"review\": {\n\t\t\t\t\"url\": \"https://www.traveloka.com/en-id/user/review/detail/HOTEL/1816762514822678658\",\n\t\t\t\t\"title\": \"\",\n\t\t\t\t\"rating\": \"9.7\",\n\t\t\t\t\"date\": \"2024-11-26T05:42:29.396000\",\n\t\t\t\t\"language\": \"English\",\n\t\t\t\t\"id\": \"1816762514822678658\",\n\t\t\t\t\"message\": \"Good place and family friendly\",\n\t\t\t\t\"rating_normalization\": {\n\t\t\t\t\t\"normal\": 9.7,\n\t\t\t\t\t\"original\": 9.7\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"user\": {\n\t\t\t\t\"id\": null,\n\t\t\t\t\"name\": \"m***d\"\n\t\t\t},\n\t\t\t\"source\": \"traveloka\",\n\t\t\t\"last_access\": \"2024-11-29T14:00:32.206065\",\n\t\t\t\"sentiment\": {\n\t\t\t\t\"meal\": \"neutral\",\n\t\t\t\t\"surrounding\": \"positive\",\n\t\t\t\t\"service\": \"positive\",\n\t\t\t\t\"location\": \"neutral\",\n\t\t\t\t\"staff\": \"positive\",\n\t\t\t\t\"facility\": \"neutral\",\n\t\t\t\t\"value\": \"neutral\",\n\t\t\t\t\"room\": \"neutral\",\n\t\t\t\t\"quality\": \"neutral\"\n\t\t\t},\n\t\t\t\"sentiment_general\": \"Positive\"\n\t\t},\n\t\t{\n\t\t\t\"review\": {\n\t\t\t\t\"url\": \"https://www.tripadvisor.co.id/ShowUserReviews-g14782503-d15067692-r981947826-Horison_Emerald_Timoho_Yogyakarta-Yogyakarta_Yogyakarta_Region_Java.html#review981947826\",\n\t\t\t\t\"title\": \"rekomendasi hotel\",\n\t\t\t\t\"rating\": \"5\",\n\t\t\t\t\"date\": \"2024-11-25T19:45:58-05:00\",\n\t\t\t\t\"language\": \"Indonesian\",\n\t\t\t\t\"id\": \"981947826\",\n\t\t\t\t\"message\": \"ke Jogja karena liburan akhir tahun, dan pilih hotel ini karena Deket sama Malioboro, behhh pelayanan nya okee banget, karyawan nya juga ramah dan cekatan, fasilitas hotel nya oke juga, oke bangeetttt dehhhh, kapan kapan kesini lagiii plissssss\",\n\t\t\t\t\"rating_normalization\": {\n\t\t\t\t\t\"normal\": 10,\n\t\t\t\t\t\"original\": 5\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"user\": {\n\t\t\t\t\"id\": \"11584501E31394202E1DF935A21F1E61\",\n\t\t\t\t\"name\": \"KUDO R\"\n\t\t\t},\n\t\t\t\"source\": \"tripadvisor\",\n\t\t\t\"last_access\": \"2024-11-26T15:31:07.625760\",\n\t\t\t\"sentiment\": {\n\t\t\t\t\"meal\": \"\",\n\t\t\t\t\"surrounding\": \"positive\",\n\t\t\t\t\"service\": \"\",\n\t\t\t\t\"location\": \"\",\n\t\t\t\t\"staff\": \"positive\",\n\t\t\t\t\"facility\": \"\",\n\t\t\t\t\"value\": \"\",\n\t\t\t\t\"room\": \"\",\n\t\t\t\t\"quality\": \"\"\n\t\t\t},\n\t\t\t\"sentiment_general\": \"Positive\",\n\t\t\t\"response\": {\n\t\t\t\t\"date\": \"2024-12-04T17:36:29-05:00\",\n\t\t\t\t\"message\": \"Selamat pagi kakak Kudor 2024 \\\"salam hangat dari @Hom Premiere Timoho \\\" Terima kasih telah meluangkan waktu untuk memberikan bintang 5 pada Kami. Untuk kunjungan berikutnya, kakak dapat menghubungi nomor reservasi kami,sehingga kamar kakak dapat kami siapkan sebaik mungkin sebelum kakak datang. Sekali lagi terima kasih dan kami tunggu ulasan luar biasa selanjutnya Salam hangat Irene Indri Dewi Astuti. SP.CHA General Manager\",\n\t\t\t\t\"language\": \"Indonesian\"\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\t\"review\": {\n\t\t\t\t\"url\": \"https://www.traveloka.com/en-id/user/review/detail/HOTEL/1816701927928379784\",\n\t\t\t\t\"title\": \"\",\n\t\t\t\t\"rating\": \"10.0\",\n\t\t\t\t\"date\": \"2024-11-25T13:39:29.231000\",\n\t\t\t\t\"language\": \"English\",\n\t\t\t\t\"id\": \"1816701927928379784\",\n\t\t\t\t\"message\": \"The breakfast food was really delicious, but because we were in a group, the food refill flow took a long time to empty, so we were disappointed, like we didn't get any fruit or salad.\",\n\t\t\t\t\"rating_normalization\": {\n\t\t\t\t\t\"normal\": 10,\n\t\t\t\t\t\"original\": 10\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"user\": {\n\t\t\t\t\"id\": \"108060857\",\n\t\t\t\t\"name\": \"Devi L. \"\n\t\t\t},\n\t\t\t\"source\": \"traveloka\",\n\t\t\t\"last_access\": \"2024-11-29T14:00:32.255104\",\n\t\t\t\"sentiment\": {\n\t\t\t\t\"meal\": \"positive\",\n\t\t\t\t\"surrounding\": \"positive\",\n\t\t\t\t\"service\": \"neutral\",\n\t\t\t\t\"location\": \"neutral\",\n\t\t\t\t\"staff\": \"neutral\",\n\t\t\t\t\"facility\": \"neutral\",\n\t\t\t\t\"value\": \"neutral\",\n\t\t\t\t\"room\": \"neutral\",\n\t\t\t\t\"quality\": \"neutral\"\n\t\t\t},\n\t\t\t\"sentiment_general\": \"Positive\"\n\t\t},\n\t\t{\n\t\t\t\"review\": {\n\t\t\t\t\"url\": \"https://www.traveloka.com/en-id/user/review/detail/HOTEL/1816656243030247554\",\n\t\t\t\t\"title\": \"Liburan Santai\",\n\t\t\t\t\"rating\": \"9.7\",\n\t\t\t\t\"date\": \"2024-11-25T01:33:20.717000\",\n\t\t\t\t\"language\": \"English\",\n\t\t\t\t\"id\": \"1816656243030247554\",\n\t\t\t\t\"message\": \"The most comfortable hotel. The room is spacious enough, there is a sofa in the room. There is a swimming pool for children's activities. There is a mini fridge (important for storing children's food). The basement car park is adequate. Late checkout is possible\",\n\t\t\t\t\"rating_normalization\": {\n\t\t\t\t\t\"normal\": 9.7,\n\t\t\t\t\t\"original\": 9.7\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"user\": {\n\t\t\t\t\"id\": null,\n\t\t\t\t\"name\": \"O***a\"\n\t\t\t},\n\t\t\t\"source\": \"traveloka\",\n\t\t\t\"last_access\": \"2024-11-27T13:58:46.946793\",\n\t\t\t\"sentiment\": {\n\t\t\t\t\"meal\": \"neutral\",\n\t\t\t\t\"surrounding\": \"positive\",\n\t\t\t\t\"service\": \"neutral\",\n\t\t\t\t\"location\": \"neutral\",\n\t\t\t\t\"staff\": \"neutral\",\n\t\t\t\t\"facility\": \"positive\",\n\t\t\t\t\"value\": \"neutral\",\n\t\t\t\t\"room\": \"positive\",\n\t\t\t\t\"quality\": \"neutral\"\n\t\t\t},\n\t\t\t\"sentiment_general\": \"Positive\",\n\t\t\t\"wordcloud\": {\n\t\t\t\t\"uncategorized\": [],\n\t\t\t\t\"status\": \"categorized\",\n\t\t\t\t\"meal\": [],\n\t\t\t\t\"surrounding\": [],\n\t\t\t\t\"general\": [\n\t\t\t\t\t{\n\t\t\t\t\t\t\"summary\": \"hotel best comfortable\",\n\t\t\t\t\t\t\"sentiment\": \"positive\",\n\t\t\t\t\t\t\"keyword\": \"hotel\"\n\t\t\t\t\t}\n\t\t\t\t],\n\t\t\t\t\"service\": [],\n\t\t\t\t\"location\": [],\n\t\t\t\t\"staff\": [],\n\t\t\t\t\"facility\": [\n\t\t\t\t\t{\n\t\t\t\t\t\t\"summary\": \"swimming pool there is\",\n\t\t\t\t\t\t\"sentiment\": \"positive\",\n\t\t\t\t\t\t\"keyword\": \"swimming pool\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"summary\": \"mini fridge (important to storing children's food)\",\n\t\t\t\t\t\t\"sentiment\": \"positive\",\n\t\t\t\t\t\t\"keyword\": \"mini fridge\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"summary\": \"basement car park adequate\",\n\t\t\t\t\t\t\"sentiment\": \"positive\",\n\t\t\t\t\t\t\"keyword\": \"basement car park\"\n\t\t\t\t\t}\n\t\t\t\t],\n\t\t\t\t\"value\": [],\n\t\t\t\t\"room\": [\n\t\t\t\t\t{\n\t\t\t\t\t\t\"summary\": \"room spacious enough\",\n\t\t\t\t\t\t\"sentiment\": \"positive\",\n\t\t\t\t\t\t\"keyword\": \"room\"\n\t\t\t\t\t},\n\t\t\t\t\t{\n\t\t\t\t\t\t\"summary\": \"sofa ada\",\n\t\t\t\t\t\t\"sentiment\": \"positive\",\n\t\t\t\t\t\t\"keyword\": \"sofa\"\n\t\t\t\t\t}\n\t\t\t\t],\n\t\t\t\t\"quality\": []\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\t\"review\": {\n\t\t\t\t\"url\": \"https://www.tripadvisor.co.id/ShowUserReviews-g14782503-d15067692-r981779984-Horison_Emerald_Timoho_Yogyakarta-Yogyakarta_Yogyakarta_Region_Java.html#review981779984\",\n\t\t\t\t\"title\": \"hotel strategis dijogja\",\n\t\t\t\t\"rating\": \"5\",\n\t\t\t\t\"date\": \"2024-11-24T20:09:52-05:00\",\n\t\t\t\t\"language\": \"Indonesian\",\n\t\t\t\t\"id\": \"981779984\",\n\t\t\t\t\"message\": \"gilsss ini hotel best bangettt asli selain harganyaa ramah dikantong, fasilitasnya kerenn puolllll, strategis juga ditengah tengah kota, deket sama malioboro dan balai kota, pelayanannya juga joss deh, hotel yang kasih nuansa serasa dirumah sendiri\",\n\t\t\t\t\"rating_normalization\": {\n\t\t\t\t\t\"normal\": 10,\n\t\t\t\t\t\"original\": 5\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"user\": {\n\t\t\t\t\"id\": \"AA0E257D27B9025DA4F5C864C5D1BCD6\",\n\t\t\t\t\"name\": \"Jet10394587107\"\n\t\t\t},\n\t\t\t\"source\": \"tripadvisor\",\n\t\t\t\"last_access\": \"2024-11-25T15:27:54.058467\",\n\t\t\t\"sentiment\": {\n\t\t\t\t\"meal\": \"\",\n\t\t\t\t\"surrounding\": \"positive\",\n\t\t\t\t\"service\": \"positive\",\n\t\t\t\t\"location\": \"positive\",\n\t\t\t\t\"staff\": \"positive\",\n\t\t\t\t\"facility\": \"\",\n\t\t\t\t\"value\": \"\",\n\t\t\t\t\"room\": \"\",\n\t\t\t\t\"quality\": \"positive\"\n\t\t\t},\n\t\t\t\"sentiment_general\": \"Positive\"\n\t\t},\n\t\t{\n\t\t\t\"review\": {\n\t\t\t\t\"url\": \"https://www.traveloka.com/en-id/user/review/detail/HOTEL/1816383101093300354\",\n\t\t\t\t\"title\": \"Urusan Bisnis\",\n\t\t\t\t\"rating\": \"8.8\",\n\t\t\t\t\"date\": \"2024-11-22T01:11:52.267000\",\n\t\t\t\t\"language\": \"English\",\n\t\t\t\t\"id\": \"1816383101093300354\",\n\t\t\t\t\"message\": \"what is certain is that the room is clean, there is an additional sofa, there is a hair dryer, the breakfast is varied and the taste is really good, I will often stay here üòä\",\n\t\t\t\t\"rating_normalization\": {\n\t\t\t\t\t\"normal\": 8.8,\n\t\t\t\t\t\"original\": 8.8\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"user\": {\n\t\t\t\t\"id\": \"188094010\",\n\t\t\t\t\"name\": \"Yarnik19 W. \"\n\t\t\t},\n\t\t\t\"source\": \"traveloka\",\n\t\t\t\"last_access\": \"2024-11-25T13:28:17.456547\",\n\t\t\t\"sentiment\": {\n\t\t\t\t\"meal\": \"positive\",\n\t\t\t\t\"surrounding\": \"positive\",\n\t\t\t\t\"service\": \"neutral\",\n\t\t\t\t\"location\": \"neutral\",\n\t\t\t\t\"staff\": \"neutral\",\n\t\t\t\t\"facility\": \"neutral\",\n\t\t\t\t\"value\": \"neutral\",\n\t\t\t\t\"room\": \"neutral\",\n\t\t\t\t\"quality\": \"neutral\"\n\t\t\t},\n\t\t\t\"sentiment_general\": \"Positive\"\n\t\t},\n\t\t{\n\t\t\t\"review\": {\n\t\t\t\t\"url\": \"https://www.tripadvisor.co.id/ShowUserReviews-g14782503-d15067692-r981333549-Horison_Emerald_Timoho_Yogyakarta-Yogyakarta_Yogyakarta_Region_Java.html#review981333549\",\n\t\t\t\t\"title\": \"hotel bintang 4 dijogja\",\n\t\t\t\t\"rating\": \"5\",\n\t\t\t\t\"date\": \"2024-11-20T16:46:00-05:00\",\n\t\t\t\t\"language\": \"Indonesian\",\n\t\t\t\t\"id\": \"981333549\",\n\t\t\t\t\"message\": \"stafff nya ramahhh bangett, saya dapat welcome cake yg cantik sangat, dan rasanya juga enak, saya juga puas sekali dengan fasilitas yang ada, makanan disini juga enak enak banget, cocok dilidah semua orang, sebagai orang diluar jogja rasa makanan friendly bangettttt dan enak, rekomend untuk kalian yg mau menikmati jogja dan butuh penginapan\",\n\t\t\t\t\"rating_normalization\": {\n\t\t\t\t\t\"normal\": 10,\n\t\t\t\t\t\"original\": 5\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"user\": {\n\t\t\t\t\"id\": \"B16E391895CD9C6607063D996AE81B78\",\n\t\t\t\t\"name\": \"Relax54346935699\"\n\t\t\t},\n\t\t\t\"source\": \"tripadvisor\",\n\t\t\t\"last_access\": \"2024-11-21T15:24:38.441299\",\n\t\t\t\"sentiment\": {\n\t\t\t\t\"meal\": \"positive\",\n\t\t\t\t\"surrounding\": \"\",\n\t\t\t\t\"service\": \"\",\n\t\t\t\t\"location\": \"\",\n\t\t\t\t\"staff\": \"positive\",\n\t\t\t\t\"facility\": \"\",\n\t\t\t\t\"value\": \"\",\n\t\t\t\t\"room\": \"\",\n\t\t\t\t\"quality\": \"positive\"\n\t\t\t},\n\t\t\t\"sentiment_general\": \"Positive\"\n\t\t},\n\t\t{\n\t\t\t\"review\": {\n\t\t\t\t\"url\": \"https://www.agoda.com/id-id/hom-premiere-timoho/reviews/yogyakarta-id.html\",\n\t\t\t\t\"title\": \"Nice\",\n\t\t\t\t\"rating\": 10.0,\n\t\t\t\t\"date\": \"2024-11-20T07:38:00\",\n\t\t\t\t\"language\": \"Romanian\",\n\t\t\t\t\"id\": 896801275,\n\t\t\t\t\"message\": \"Nice place\",\n\t\t\t\t\"rating_normalization\": {\n\t\t\t\t\t\"normal\": 10,\n\t\t\t\t\t\"original\": 10\n\t\t\t\t}\n\t\t\t},\n\t\t\t\"user\": {\n\t\t\t\t\"id\": \"b28d14497f8a2d6ccaf5512d5d188ea38dc614e9\",\n\t\t\t\t\"name\": \"Rheza\"\n\t\t\t},\n\t\t\t\"source\": \"agoda\",\n\t\t\t\"last_access\": \"2024-11-20T14:12:57.615375\",\n\t\t\t\"sentiment_general\": \"Positive\"\n\t\t}\n\t],\n\t\"status\": \"success\",\n\t\"status_code\": 201,\n\t\"watermark\": \"datains ¬© 2022\"\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -5440,
        -3920
      ],
      "id": "4e79397a-3bd7-441a-8942-6766469775d9",
      "name": "Mock data",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Send a text message').item.json.result.chat.id }}",
        "messageId": "={{ $('Send a text message').item.json.result.message_id }}",
        "text": "‚ÑπÔ∏è Sedang mengekstrak informasi dari perintah Anda",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3344,
        -3792
      ],
      "id": "48f80a11-9d06-41a6-8e25-d04925b5845a",
      "name": "Edit a text message1",
      "webhookId": "4a32a373-53e2-4c6a-9625-58d1b63f0dce",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        -9904,
        -2512
      ],
      "id": "a2cd5438-60ae-4191-a3bb-3ae0cc79baac",
      "name": "When clicking ‚ÄòExecute workflow‚Äô"
    },
    {
      "parameters": {
        "content": "## Routine Report Notification",
        "height": 496,
        "width": 1952
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -9664,
        -3104
      ],
      "typeVersion": 1,
      "id": "1687edd3-5df8-4b94-a1a1-3c35ecc42036",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours"
            },
            {
              "field": "months",
              "triggerAtHour": 7
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -9904,
        -2736
      ],
      "id": "20828556-bb65-42ce-a9b4-d1bf963dde9c",
      "name": "Trigger one hours",
      "disabled": true
    },
    {
      "parameters": {
        "url": "https://guvumfzbizmhvtudwzfa.supabase.co/rest/v1/user",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "select",
              "value": "*, reviews(*)"
            },
            {
              "name": "token_api",
              "value": "not.is.nulll"
            },
            {
              "name": "or",
              "value": "=(day.eq.{{ $now.setZone(\"Asia/Jakarta\").setLocale('id').toFormat('EEEE').toLowerCase() }},date.eq.{{ $now.setZone(\"Asia/Jakarta\").toFormat('d') }})"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -9568,
        -2944
      ],
      "id": "54042a45-6165-4fd5-9bb5-61186f1e3313",
      "name": "Supabase API",
      "credentials": {
        "supabaseApi": {
          "id": "tux4n9M75BJM11U2",
          "name": "Supabase main"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "8c287a0a-e728-49be-ba07-5f68234edc45",
              "leftValue": "={{ $json.schedule }}",
              "rightValue": "mingguan",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -9392,
        -2944
      ],
      "id": "3b363e1d-498d-48bd-aace-3205ddae7103",
      "name": "Time is OK & Weekly"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "7boTKvSi67hPtZZY",
          "mode": "list",
          "cachedResultUrl": "/workflow/7boTKvSi67hPtZZY",
          "cachedResultName": "SubWorkflow - Generate Routine Report"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "prompt_lengkap": "={{ $json.prompt_lengkap }}",
            "telegram_chat_id": "={{ $('Time is OK & Weekly').item.json.user.last().telegram_chat_id.toString() }}",
            "start_date": "={{ $now.minus(7, 'days').format('yyyy-MM-dd') }}",
            "end_date": "={{ $now.minus(1, 'days').format('yyyy-MM-dd') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "prompt_lengkap",
              "displayName": "prompt_lengkap",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "start_date",
              "displayName": "start_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "end_date",
              "displayName": "end_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        -8672,
        -3008
      ],
      "id": "eb5fd0eb-bacc-4fdf-8824-c563f95721da",
      "name": "Generate Report Notification - Weekly"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "7boTKvSi67hPtZZY",
          "mode": "list",
          "cachedResultUrl": "/workflow/7boTKvSi67hPtZZY",
          "cachedResultName": "SubWorkflow - Generate Routine Report"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "prompt_lengkap": "={{ $json.prompt_lengkap }}",
            "telegram_chat_id": "={{ $('Time is OK & Weekly').item.json.user.last().telegram_chat_id.toString() }}",
            "start_date": "={{ $now.minus(1, 'month').startOf('month').format('yyyy-MM-dd') }}",
            "end_date": "{{ $now.minus(1, 'month').endOf('month').format('yyyy-MM-dd') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "prompt_lengkap",
              "displayName": "prompt_lengkap",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "start_date",
              "displayName": "start_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "end_date",
              "displayName": "end_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        -8672,
        -2832
      ],
      "id": "6370e4e1-89b3-4a09-949d-d82db41e2cc2",
      "name": "Generate Report Notification - Monthly"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "iKXJJgOVIZzxvTl9",
          "mode": "list",
          "cachedResultUrl": "/workflow/iKXJJgOVIZzxvTl9",
          "cachedResultName": "Subworkflow - Get Data Reviews From API Robota"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "api_key": "={{ $json.token_api }}",
            "refresh_token": "={{ $json.refresh_token }}",
            "telegram_chat_id": "={{ $json.telegram_chat_id }}",
            "start_date": "={{ $now.minus(7, 'days').format('yyyy-MM-dd') }}",
            "end_date": "={{ $now.minus(1, 'days').format('yyyy-MM-dd') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "api_key",
              "displayName": "api_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "refresh_token",
              "displayName": "refresh_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number"
            },
            {
              "id": "start_date",
              "displayName": "start_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "end_date",
              "displayName": "end_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "ota",
              "displayName": "ota",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "sentiment",
              "displayName": "sentiment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "rating",
              "displayName": "rating",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        -9200,
        -3008
      ],
      "id": "4d3c37ab-9a41-418e-8dbb-e9c5eb801ce0",
      "name": "Subworkflow Get Data Reviews - Weekly"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "iKXJJgOVIZzxvTl9",
          "mode": "list",
          "cachedResultUrl": "/workflow/iKXJJgOVIZzxvTl9",
          "cachedResultName": "Subworkflow - Get Data Reviews From API Robota"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "api_key": "={{ $json.token_api }}",
            "refresh_token": "={{ $json.refresh_token }}",
            "telegram_chat_id": "={{ $('Time is OK & Weekly').item.json.user.last().telegram_chat_id.toString() }}",
            "start_date": "={{ $now.startOf('month').minus(1, 'month').format('yyyy-MM-dd')}}",
            "end_date": "={{ $now.endOf('month').minus(1, 'month').format('yyyy-MM-dd')}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "api_key",
              "displayName": "api_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "refresh_token",
              "displayName": "refresh_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number"
            },
            {
              "id": "start_date",
              "displayName": "start_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "end_date",
              "displayName": "end_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "ota",
              "displayName": "ota",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "sentiment",
              "displayName": "sentiment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "rating",
              "displayName": "rating",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        -9200,
        -2832
      ],
      "id": "0113d2c0-fa98-4948-94fc-db6442a09a45",
      "name": "SubWorkflow Get Data Reviews"
    },
    {
      "parameters": {
        "url": "https://guvumfzbizmhvtudwzfa.supabase.co/rest/v1/user",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "select",
              "value": "*, reviews(*)"
            },
            {
              "name": "token_api",
              "value": "not.is.nulll"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -5776,
        -3120
      ],
      "id": "10ff97fd-9b36-41fa-b847-e49e1162017e",
      "name": "Supabase API - Get User with Signed",
      "credentials": {
        "supabaseApi": {
          "id": "tux4n9M75BJM11U2",
          "name": "Supabase main"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "iKXJJgOVIZzxvTl9",
          "mode": "list",
          "cachedResultUrl": "/workflow/iKXJJgOVIZzxvTl9",
          "cachedResultName": "Subworkflow - Get Data Reviews From API Robota"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "telegram_chat_id": "={{ $json.telegram_chat_id }}",
            "api_key": "={{ $json.token_api }}",
            "refresh_token": "={{ $json.refresh_token }}",
            "start_date": "={{ $now.minus(8, 'month').format('yyyy-MM-dd') }}",
            "end_date": "={{ $now.minus(8, 'month').format('yyyy-MM-dd') }}",
            "ota": "all",
            "sentiment": "neutral",
            "rating": -1
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "api_key",
              "displayName": "api_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "refresh_token",
              "displayName": "refresh_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "telegram_chat_id",
              "displayName": "telegram_chat_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number"
            },
            {
              "id": "start_date",
              "displayName": "start_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "end_date",
              "displayName": "end_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "ota",
              "displayName": "ota",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "sentiment",
              "displayName": "sentiment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "rating",
              "displayName": "rating",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        -5600,
        -3120
      ],
      "id": "d4192340-abc2-44f0-aafc-daf2f41a4c4a",
      "name": "Sub Workflow - Get Data Critical Review Today",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// --- SCRIPT PERSIAPAN DATA LAPORAN UNTUK GEMINI ---\n\n// 1. Mengambil data dari node sebelumnya (HTTP Request)\n// Kita asumsikan outputnya ada di .data, sesuai screenshot Anda\nconst reviewsData = $input.first().json.data;\n\n// 2. Mengambil pertanyaan pengguna (sesuai kode Anda)\nconst userQuery = \"Tolong Buatkan laporan rutin untuk manager hotel\";\n\nlet formattedReviews = \"Berikut adalah konteks data ulasan hotel dalam format teks yang mudah dibaca untuk Anda analisis:\\n\\n\";\n\n// 3. Looping untuk setiap ulasan di dalam data\nfor (const item of reviewsData) {\n  // 'item' adalah data[0], data[1], dst.\n  // Pastikan ada objek 'review' di dalamnya\n  if (!item.review) {\n    continue; // Lewati item ini jika tidak ada data review\n  }\n\n  const review = item.review;\n\n  // --- Ekstraksi Data Review Utama ---\n  let ota = \"Unknown\";\n  if (review.url && review.url.includes(\"google\")) ota = \"Google Maps\";\n  else if (review.url && review.url.includes(\"agoda\")) ota = \"Agoda\";\n  else if (review.url && review.url.includes(\"traveloka\")) ota = \"Traveloka\";\n\n  const rating = review.rating_normalization ? `${review.rating_normalization.normal}/10` : (review.rating ? `${review.rating}/10` : 'N/A');\n  const date = review.date ? new Date(review.date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' }) : 'Tanggal tidak tersedia';\n  const message = review.message || 'Ulasan kosong';\n  \n  // Ambil sentimen general dari (image_b966fb.png)\n  const overallSentiment = item.sentiment ? item.sentiment.sentiment_general : 'N/A';\n\n  formattedReviews += `--- Ulasan dari ${ota} ---\\n`;\n  formattedReviews += `Rating: ${rating}\\n`;\n  formattedReviews += `Sentimen Global: ${overallSentiment}\\n`;\n  formattedReviews += `Tanggal: ${date}\\n`;\n  formattedReviews += `Ulasan Lengkap: ${message}\\n`;\n\n  // --- INI BAGIAN PENTING YANG BARU ---\n  // Mengambil data terkategori dari (image_b969e4.png & image_b96a08.png)\n  \n  const categories = ['facility', 'room', 'service', 'staff', 'location', 'meal', 'value', 'quality'];\n  let positivePoints = [];\n  let negativePoints = [];\n\n  // Loop melalui setiap kategori (facility, room, dll.)\n  for (const category of categories) {\n    // Cek apakah item ini punya kategori tersebut & apakah itu sebuah array\n    if (item[category] && Array.isArray(item[category])) {\n      \n      // Loop melalui setiap temuan di dalam kategori itu (misal: facility[0], facility[1])\n      for (const summaryItem of item[category]) {\n        if (summaryItem.sentiment === 'positive') {\n          positivePoints.push(summaryItem.summary);\n        } else if (summaryItem.sentiment === 'negative') {\n          negativePoints.push(summaryItem.summary);\n        }\n      }\n    }\n  }\n\n  // Tambahkan poin-poin yang ditemukan ke dalam teks\n  if (positivePoints.length > 0) {\n    formattedReviews += `Poin Positif: ${positivePoints.join(', ')}\\n`;\n  }\n  if (negativePoints.length > 0) {\n    formattedReviews += `Poin Negatif: ${negativePoints.join(', ')}\\n`;\n  }\n  \n  formattedReviews += `\\n`; // Beri spasi sebelum ulasan berikutnya\n}\n\n// 4. Handle jika tidak ada ulasan ditemukan\nconst defaultText = \"Berikut adalah konteks data ulasan hotel dalam format teks yang mudah dibaca untuk Anda analisis:\\n\\n\";\nif (formattedReviews === defaultText) {\n  formattedReviews = \"Tidak ada ulasan yang ditemukan dalam rentang waktu ini.\";\n}\n\n// 5. Menggabungkan semuanya menjadi prompt_lengkap yang final\nconst prompt_lengkap = `${formattedReviews}--- TUGAS ANDA ---\\nBerdasarkan data ulasan di atas, laksanakan tugas atau jawab pertanyaan dari pengguna berikut: \"${userQuery}\"`;\n\n// 6. Mengembalikan hasilnya untuk node Gemini\nreturn [{\n  json: {\n    prompt_lengkap: prompt_lengkap\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8992,
        -2832
      ],
      "id": "95e76404-44dd-4bcb-9210-71f80d7a2189",
      "name": "Edit_Field6"
    },
    {
      "parameters": {
        "jsCode": "// --- SCRIPT PERSIAPAN DATA LAPORAN UNTUK GEMINI ---\n\n// 1. Mengambil data dari node sebelumnya (HTTP Request)\n// Kita asumsikan outputnya ada di .data, sesuai screenshot Anda\nconst reviewsData = $input.first().json.data;\n\n// 2. Mengambil pertanyaan pengguna (sesuai kode Anda)\nconst userQuery = \"Tolong Buatkan laporan rutin untuk manager hotel\";\n\nlet formattedReviews = \"Berikut adalah konteks data ulasan hotel dalam format teks yang mudah dibaca untuk Anda analisis:\\n\\n\";\n\n// 3. Looping untuk setiap ulasan di dalam data\nfor (const item of reviewsData) {\n  // 'item' adalah data[0], data[1], dst.\n  // Pastikan ada objek 'review' di dalamnya\n  if (!item.review) {\n    continue; // Lewati item ini jika tidak ada data review\n  }\n\n  const review = item.review;\n\n  // --- Ekstraksi Data Review Utama ---\n  let ota = \"Unknown\";\n  if (review.url && review.url.includes(\"google\")) ota = \"Google Maps\";\n  else if (review.url && review.url.includes(\"agoda\")) ota = \"Agoda\";\n  else if (review.url && review.url.includes(\"traveloka\")) ota = \"Traveloka\";\n\n  const rating = review.rating_normalization ? `${review.rating_normalization.normal}/10` : (review.rating ? `${review.rating}/10` : 'N/A');\n  const date = review.date ? new Date(review.date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' }) : 'Tanggal tidak tersedia';\n  const message = review.message || 'Ulasan kosong';\n  \n  // Ambil sentimen general dari (image_b966fb.png)\n  const overallSentiment = item.sentiment ? item.sentiment.sentiment_general : 'N/A';\n\n  formattedReviews += `--- Ulasan dari ${ota} ---\\n`;\n  formattedReviews += `Rating: ${rating}\\n`;\n  formattedReviews += `Sentimen Global: ${overallSentiment}\\n`;\n  formattedReviews += `Tanggal: ${date}\\n`;\n  formattedReviews += `Ulasan Lengkap: ${message}\\n`;\n\n  // --- INI BAGIAN PENTING YANG BARU ---\n  // Mengambil data terkategori dari (image_b969e4.png & image_b96a08.png)\n  \n  const categories = ['facility', 'room', 'service', 'staff', 'location', 'meal', 'value', 'quality'];\n  let positivePoints = [];\n  let negativePoints = [];\n\n  // Loop melalui setiap kategori (facility, room, dll.)\n  for (const category of categories) {\n    // Cek apakah item ini punya kategori tersebut & apakah itu sebuah array\n    if (item[category] && Array.isArray(item[category])) {\n      \n      // Loop melalui setiap temuan di dalam kategori itu (misal: facility[0], facility[1])\n      for (const summaryItem of item[category]) {\n        if (summaryItem.sentiment === 'positive') {\n          positivePoints.push(summaryItem.summary);\n        } else if (summaryItem.sentiment === 'negative') {\n          negativePoints.push(summaryItem.summary);\n        }\n      }\n    }\n  }\n\n  // Tambahkan poin-poin yang ditemukan ke dalam teks\n  if (positivePoints.length > 0) {\n    formattedReviews += `Poin Positif: ${positivePoints.join(', ')}\\n`;\n  }\n  if (negativePoints.length > 0) {\n    formattedReviews += `Poin Negatif: ${negativePoints.join(', ')}\\n`;\n  }\n  \n  formattedReviews += `\\n`; // Beri spasi sebelum ulasan berikutnya\n}\n\n// 4. Handle jika tidak ada ulasan ditemukan\nconst defaultText = \"Berikut adalah konteks data ulasan hotel dalam format teks yang mudah dibaca untuk Anda analisis:\\n\\n\";\nif (formattedReviews === defaultText) {\n  formattedReviews = \"Tidak ada ulasan yang ditemukan dalam rentang waktu ini.\";\n}\n\n// 5. Menggabungkan semuanya menjadi prompt_lengkap yang final\nconst prompt_lengkap = `${formattedReviews}--- TUGAS ANDA ---\\nBerdasarkan data ulasan di atas, laksanakan tugas atau jawab pertanyaan dari pengguna berikut: \"${userQuery}\"`;\n\n// 6. Mengembalikan hasilnya untuk node Gemini\nreturn [{\n  json: {\n    prompt_lengkap: prompt_lengkap\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8992,
        -3008
      ],
      "id": "02631685-52fc-48fe-af6f-39a182a915a3",
      "name": "Edit_Field"
    },
    {
      "parameters": {
        "content": "## Backup\n**Double click** to edit me. [Guide](https://docs.n8n.io/workflows/sticky-notes/)==",
        "height": 1584,
        "width": 4304,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -5872,
        -4528
      ],
      "typeVersion": 1,
      "id": "cc51d074-a0b0-4a82-a325-8951e62f70a8",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "updates": [
          "message",
          "callback_query",
          "*"
        ],
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.1,
      "position": [
        -6768,
        -1040
      ],
      "id": "653af941-fa63-4e4f-a8ca-a53fbe348395",
      "name": "Telegram Trigger Chatbot",
      "webhookId": "66eed568-f3ea-49de-bd6c-d64d08820be4",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b96b8ef5-ae03-4cb7-b53a-8b08789b99ef",
              "leftValue": "={{ $json}}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5696,
        -1040
      ],
      "id": "eb399963-ec5a-40b7-9922-91ff507d56fc",
      "name": "User Data in Database?",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b72f681c-c8db-4f4b-bf83-e95d6b794a0a",
              "leftValue": "={{ $('User Data in Database?').item.json.user_robota_id }}",
              "rightValue": "401",
              "operator": {
                "type": "number",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5248,
        -1136
      ],
      "id": "b7df51df-9c7e-46d7-ade8-284db04f1a7b",
      "name": "is Login Robota Account?"
    },
    {
      "parameters": {
        "tableId": "user",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "telegram_chat_id",
              "fieldValue": "={{ $('Telegram Trigger Chatbot').item.json.message.chat.id }}"
            },
            {
              "fieldId": "telegram_username",
              "fieldValue": "={{ $('Telegram Trigger Chatbot').item.json.message.chat.username }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5248,
        -880
      ],
      "id": "d7c0f1f5-04e0-4735-b28f-c51af6a3fb9f",
      "name": "Supabase - Create User",
      "credentials": {
        "supabaseApi": {
          "id": "xpXypIaDFMnlAjAT",
          "name": "Supabase account v2"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Telegram Trigger Chatbot').item.json.message.chat.id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.message_id }}",
        "replyMarkup": "inlineKeyboard",
        "text": "Silahkan login terlebih dahulu",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "Login",
                    "additionalFields": {
                      "url": "={{ \"https://authclerk-n8n.vercel.app/login?tele_id=\" + $('Telegram Trigger Chatbot').item.json.message.chat.id}}"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -5024,
        -928
      ],
      "id": "c500da3a-6b94-443a-94b0-afe2bfc3ae8d",
      "name": "Send Messages - Login First",
      "webhookId": "06bae668-eac7-463b-b9ee-a2de130dfbf8",
      "credentials": {
        "telegramApi": {
          "id": "MEpuMdZJSpQctM3M",
          "name": "Telegram account- delin"
        }
      }
    },
    {
      "parameters": {
        "url": "https://ujijqilperkjeyinrkwm.supabase.co/rest/v1/user",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "select",
              "value": "*, user_robota(*)"
            },
            {
              "name": "telegram_chat_id",
              "value": "=eq.{{ $('Telegram Trigger Chatbot').item.json.callback_query.message.chat.id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -5936,
        -1120
      ],
      "id": "06542de5-3757-4333-9f15-e07fac262c03",
      "name": "Get Data User - Supabase V2",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "xpXypIaDFMnlAjAT",
          "name": "Supabase account v2"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $json.telegram_chat_id }}",
        "text": "üîë Sedang mengecek Anda apakah sudah melakukan login atau belum",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -5472,
        -1136
      ],
      "id": "8d80136e-427d-45b9-948d-a08108d65b3e",
      "name": "Send a text \"Login Process\" - Telegram",
      "webhookId": "4a32a373-53e2-4c6a-9625-58d1b63f0dce",
      "credentials": {
        "telegramApi": {
          "id": "MEpuMdZJSpQctM3M",
          "name": "Telegram account- delin"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{$('Telegram Trigger Chatbot').item.json.message.chat.id }}\n",
        "text": "‚è≥ Sedang menganalisis review Anda...",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -5040,
        -640
      ],
      "id": "fe8bc871-3bad-43b3-8772-6601a3c2aeb6",
      "name": "Send a \"Processing User Command\" - Telegram",
      "webhookId": "915256f3-2467-4c7b-94b3-641786d9b565",
      "credentials": {
        "telegramApi": {
          "id": "MEpuMdZJSpQctM3M",
          "name": "Telegram account- delin"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.chat.id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.message_id }}",
        "text": "‚ÑπÔ∏è Sedang mengekstrak informasi dari perintah Anda",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4160,
        -928
      ],
      "id": "465fe1c4-2555-45ea-b9f9-9f72e4ec7a95",
      "name": "Edit Message \"Extract Information\" - Telegram",
      "webhookId": "4a32a373-53e2-4c6a-9625-58d1b63f0dce",
      "credentials": {
        "telegramApi": {
          "id": "MEpuMdZJSpQctM3M",
          "name": "Telegram account- delin"
        }
      }
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours"
            },
            {
              "field": "months",
              "triggerAtHour": 7
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -9440,
        -2432
      ],
      "id": "a78b976a-54a4-4053-9aba-adfaba22a8d1",
      "name": "Trigger one hours1",
      "disabled": true
    },
    {
      "parameters": {
        "content": "## Notif Urgent\n",
        "height": 720,
        "width": 1952,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -9664,
        -2576
      ],
      "typeVersion": 1,
      "id": "8387516b-db50-450f-9776-06deb32a2444",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "iKXJJgOVIZzxvTl9",
          "mode": "list",
          "cachedResultUrl": "/workflow/iKXJJgOVIZzxvTl9",
          "cachedResultName": "Subworkflow - Get Data Reviews From API Robota"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "api_key": "={{ $json.token_api }}",
            "refresh_token": "={{ $json.refresh_token }}",
            "start_date": "={{new Date(2025, 1, 26).toDateTime().format('yyyy-MM-dd')  }}",
            "end_date": "={{new Date(2025, 1, 26).toDateTime().format('yyyy-MM-dd')  }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "api_key",
              "displayName": "api_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "refresh_token",
              "displayName": "refresh_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "start_date",
              "displayName": "start_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "end_date",
              "displayName": "end_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "ota",
              "displayName": "ota",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "sentiment",
              "displayName": "sentiment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "rating",
              "displayName": "rating",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -9184,
        -2208
      ],
      "id": "7e792d91-efce-47c4-97b4-1763f1e377c8",
      "name": "Testing - Get Data Reviews (Notif Urgent) - API Robota"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "iKXJJgOVIZzxvTl9",
          "mode": "list",
          "cachedResultUrl": "/workflow/iKXJJgOVIZzxvTl9",
          "cachedResultName": "Subworkflow - Get Data Reviews From API Robota"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "api_key": "={{ $json.api_token }}",
            "refresh_token": "={{ $json.refresh_token }}",
            "start_date": "={{ $now.format('yyyy-MM-dd') }}",
            "end_date": "={{$now.format('yyyy-MM-dd')}}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "api_key",
              "displayName": "api_key",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "refresh_token",
              "displayName": "refresh_token",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "start_date",
              "displayName": "start_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "end_date",
              "displayName": "end_date",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "ota",
              "displayName": "ota",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "sentiment",
              "displayName": "sentiment",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": true
            },
            {
              "id": "rating",
              "displayName": "rating",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {}
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        -8992,
        -2432
      ],
      "id": "69851e35-5b7f-44ef-a30c-49000327a452",
      "name": "Production - Get Data Reviews (Notif Urgent) - API Robota1"
    },
    {
      "parameters": {
        "url": "https://ujijqilperkjeyinrkwm.supabase.co/rest/v1/user_robota",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "select",
              "value": "*, reviews(id,metadata,review_text, user_robota_id,notified_status,embedding_status,updated_at),user(telegram_chat_id))"
            },
            {
              "name": "reviews.metadata->>review_date",
              "value": "=like.{{ $now.minus(186, 'days').format('yyyy-MM-dd') }}*"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -9424,
        -2160
      ],
      "id": "4deaf281-d23d-4fd3-9d64-be1b98da1f93",
      "name": "Get Data User and Reviews- Supabase v2",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "xpXypIaDFMnlAjAT",
          "name": "Supabase account v2"
        }
      }
    },
    {
      "parameters": {
        "url": "https://ujijqilperkjeyinrkwm.supabase.co/rest/v1/user_robota",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "select",
              "value": "*, reviews(id,metadata,review_text, user_robota_id,notified_status,embedding_status,updated_at)"
            },
            {
              "name": "reviews.metadata->>review_date",
              "value": "=like.{{ $now.format('yyyy-MM-dd') }}*"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -9248,
        -2432
      ],
      "id": "133e2fb3-53bf-487d-9f7b-a125a175bc9f",
      "name": "Prod - Get Data User and Reviews- Supabase v",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "xpXypIaDFMnlAjAT",
          "name": "Supabase account v2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nconst reviews = []\n\nfor (const user of $input.all()) {\n  for (const review of user.json.reviews) {\n    \n  reviews.push({\n    metadata: review.metadata,\n    review_text: review.review_text\n  });\n  }\n}\n\n// buat testing\nif (reviews[1]){\n  return [reviews[1]]\n}\nreturn []\n\n// buat production\n// return reviews\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8992,
        -2032
      ],
      "id": "f5bc85d1-ceed-4e2c-9950-12a6001692e5",
      "name": "Get Data Reviews",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nconst reviewsInput = $input.first().json.data\nconst reviews = []\n\nfor (const data of reviewsInput) {\n    const reviewText = `${data.review.message}`;\n    \n    // --- 2. Tambahkan ke batch Supabase (untuk \"dijodohkan\" nanti) ---\n    const metadata = {\n      rating: data.review.rating,\n      review_date: data.review.date,\n      ota: data.source,\n      sentiment: data.sentiment, \n      user_name: data.user.name\n    };\n    \n    reviews.push({\n      // id: `${data.review.id}`,\n      review_text: reviewText,\n      metadata: metadata,\n    });\n}\n\nreturn reviews;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8992,
        -2208
      ],
      "id": "1e5abb27-efc0-4e4a-a63a-f571640f57fd",
      "name": "Transform Data Reviews",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "mergeByFields": {
          "values": [
            {
              "field1": "metadata.review_date",
              "field2": "metadata.review_date"
            }
          ]
        },
        "resolve": "preferInput1",
        "options": {
          "skipFields": "review_text,metadata.hotel_name,metadata.hotel_id,metadata.sentiment"
        }
      },
      "type": "n8n-nodes-base.compareDatasets",
      "typeVersion": 2.3,
      "position": [
        -8752,
        -2208
      ],
      "id": "1764ebb5-75e6-4113-8bbf-de1d0eed6aa1",
      "name": "Compare Datasets"
    },
    {
      "parameters": {
        "tableId": "reviews",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "review_text",
              "fieldValue": "={{ $json.review_text }}"
            },
            {
              "fieldId": "metadata",
              "fieldValue": "={{ $json.metadata }}"
            },
            {
              "fieldId": "user_robota_id",
              "fieldValue": "={{ $('Get Data User and Reviews- Supabase v2').item.json.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -8496,
        -2272
      ],
      "id": "0d6aac7f-ac04-4ef5-a550-fc81aea5d10c",
      "name": "Create a New Review (Not Embed) - Supabase v2",
      "credentials": {
        "supabaseApi": {
          "id": "xpXypIaDFMnlAjAT",
          "name": "Supabase account v2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nconst users = $('Get Data User and Reviews- Supabase v2').first().json.user\n// for (const user of users ) {\n//   item.json.myNewField = 1;\n// }\n\nreturn users;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -8096,
        -2384
      ],
      "id": "4e785a91-854d-4be8-ac70-7cb875157e8d",
      "name": "Get User Tele - Code"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "a7b5b6bc-ae4c-44c6-9db7-1762f8cb72e7",
              "leftValue": "={{ $json.metadata.sentiment.meal }}",
              "rightValue": "negative",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "dd6b0547-1813-4bda-a354-c077e27318a6",
              "leftValue": "={{ $json.metadata.sentiment.staff }}",
              "rightValue": "negative",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "ddd14eb6-9b16-4d25-b129-d695bdc7ba00",
              "leftValue": "={{ $json.metadata.sentiment.value }}",
              "rightValue": "negative",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "c31eaa27-5b98-4915-9615-04da2a4f62c1",
              "leftValue": "={{ $json.metadata.sentiment.quality }}",
              "rightValue": "negative",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "874cd3a8-6405-48a9-875a-103b8ac2efc7",
              "leftValue": "={{ $json.metadata.sentiment.service }}",
              "rightValue": "negative",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "6a001f1e-df20-4d9c-a66e-62158b639e78",
              "leftValue": "={{ $json.metadata.sentiment.facility }}",
              "rightValue": "negative",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "4d1817b7-cf89-42fa-af95-7599ea585f6f",
              "leftValue": "={{ $json.metadata.sentiment.location }}",
              "rightValue": "negative",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "8ccb1626-53e6-49e9-a521-5ac4b3d38f06",
              "leftValue": "={{ $json.metadata.sentiment.surrounding }}",
              "rightValue": "negative",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            },
            {
              "id": "2b960f5d-53f6-4fc8-9276-e366b5e965b5",
              "leftValue": "={{ $json.metadata.sentiment.room }}",
              "rightValue": "negative",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -8304,
        -2288
      ],
      "id": "b6bcfbad-4cfa-4e1a-8c1b-f5b46b336fad",
      "name": "Is Urgent Review?"
    },
    {
      "parameters": {
        "chatId": "={{ $json.telegram_chat_id }}",
        "text": "=üö® **URGENT ALERT: REVIEW NEGATIF** üö®\n\nüìâ **Rating:** {{ $('Is Urgent Review?').item.json.metadata.rating }}/10\nüè® **Platform:** {{$('Is Urgent Review?').item.json.metadata.ota}}\nüë§ **Tamu:** {{$('Is Urgent Review?').item.json.metadata.user_name}}\nüóì **Tanggal:** {{ $('Is Urgent Review?').item.json.metadata.review_date.toDateTime().format('dd-MM-yyyy') }}\n\nüìù **Keluhan Utama:**\n\"{{$('Is Urgent Review?').item.json.review_text}}\"\n\n‚ö†Ô∏è *Mohon segera diinvestigasi dan direspon!*",
        "additionalFields": {
          "appendAttribution": false,
          "parse_mode": "Markdown"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -7888,
        -2384
      ],
      "id": "2873e306-a8d4-477f-be70-5bac85d3ff47",
      "name": "Sent Urgent Review",
      "webhookId": "dd9bb3f8-2cc8-4f58-9df1-40c01ec5747d",
      "credentials": {
        "telegramApi": {
          "id": "MEpuMdZJSpQctM3M",
          "name": "Telegram account- delin"
        }
      }
    },
    {
      "parameters": {
        "content": "## Node For Production",
        "height": 224,
        "width": 992
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -9520,
        -2496
      ],
      "id": "7d68ee15-fd8b-4a1c-b33e-225ac210da05",
      "name": "Sticky Note5"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "bb84d563-42c8-4005-ae97-2f9cce88442a",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -9168,
        -3584
      ],
      "id": "29bc3666-47d3-41c3-a251-fbb7e046b3f7",
      "name": "Login Via Web",
      "webhookId": "bb84d563-42c8-4005-ae97-2f9cce88442a",
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.robota.app/v1.1/auth/login",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n\t\"email\": \"{{ $json.body.email }}\",\n\t\"password\": \"{{ $json.body.password }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -8896,
        -3584
      ],
      "id": "bc11e5ef-ed13-40b9-a35b-ae5684d4388b",
      "name": "HTTP Request4",
      "alwaysOutputData": false,
      "disabled": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "url": "https://api.robota.app/v1.1/analyst/reviews",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "start_date",
              "value": "={{ $now.startOf('year').format('yyyy-MM-dd') }}"
            },
            {
              "name": "end_date",
              "value": "={{ $now.minus('7', 'day').format('yyyy-MM-dd') }}"
            },
            {
              "name": "ota",
              "value": "="
            },
            {
              "name": "page",
              "value": "1"
            },
            {
              "name": "limit",
              "value": "10"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "pagination": {
            "pagination": {
              "parameters": {
                "parameters": [
                  {
                    "name": "page",
                    "value": "={{ $response.body.pagination.page + 1 }}"
                  }
                ]
              },
              "paginationCompleteWhen": "other",
              "completeExpression": "={{ $response.body.data.isEmpty() }}"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -7968,
        -3488
      ],
      "id": "abc5a263-d202-4ee5-b480-f9f8931fc9fa",
      "name": "Get Reviews Last Years - API Robota",
      "credentials": {
        "httpBearerAuth": {
          "id": "Bt2zPpmApfaRkVSb",
          "name": "Get Token From Upsert Robota"
        }
      },
      "disabled": true,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "url": "https://api.robota.app/v1.1/account/preference/hotel",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBearerAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -7968,
        -3680
      ],
      "id": "93dfcaa2-9af5-4c98-a368-92ca0c9deb3d",
      "name": "Get Data Hotel - API Robota",
      "credentials": {
        "httpBearerAuth": {
          "id": "Bt2zPpmApfaRkVSb",
          "name": "Get Token From Upsert Robota"
        }
      },
      "disabled": true
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -7744,
        -3680
      ],
      "id": "8a8592e1-0ed8-47e5-95fb-8df4e54dc86e",
      "name": "Merge",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "/*\n  Node ini bertugas menggabungkan 3 sumber data untuk BATCH SAAT INI:\n  1. Metadata (dari 'Prepared Text Before Embeding Process')\n  2. Vektor (dari 'HTTP Request')\n  3. ID User (dari 'Update User Data - Supabase V2')\n*/\n\n// 1Ô∏è‚É£ Ambil data metadata untuk BATCH SAAT INI (FIXED)\n// Ganti 'Prepared Text Before Embeding Process' dengan nama node Anda\nconst dataSiapSimpan = $('Prepared Text Before Embeding Process').itemMatching($runIndex).json.supabaseData;\n\n// 2Ô∏è‚É£ Ambil hasil embedding dari node sebelumnya (FIXED)\n// (Saya asumsikan format API terakhir: { \"data\": [...] } )\nconst embeddingData = $input.first().json.embeddings;\n\n// 3Ô∏è‚É£ Ambil user ID dari node lain (Ini sudah OK)\nconst userRobotaId = $('Update User Data - Supabase V2').first().json.id;\nif (!userRobotaId) {\n  throw new Error(\"Tidak dapat menemukan 'user_robota_id' dari node 'Update User Data - Supabase V2'\");\n}\n\n// 4Ô∏è‚É£ Validasi jumlah data dan embedding (FIXED)\nif (dataSiapSimpan.length !== embeddingData.length) {\n  throw new Error(\n    `Jumlah data dan embedding tidak cocok! Batch index: ${$runIndex}. ` +\n    `Data: ${dataSiapSimpan.length}, Embeddings: ${embeddingData.length}`\n  );\n}\n\n// 5Ô∏è‚É£ Gabungkan data\nconst finalBatchForSupabase = [];\n\nfor (let i = 0; i < dataSiapSimpan.length; i++) {\n  \n  // Ambil data dari batch yang sudah disiapkan (FIXED)\n  const prepData = dataSiapSimpan[i];\n  \n  // Ambil vektor dari batch embedding (FIXED)\n  const embeddingVector = embeddingData[i];\n\n  // Dorong objek BERSIH, tanpa wrapper 'json:' (FIXED)\n  finalBatchForSupabase.push({\n    review_text: prepData.semanticText,\n    metadata: prepData.metadata,\n    embedding: embeddingVector,\n    user_robota_id: userRobotaId,\n    embedding_status: 'completed'\n  });\n}\n\n// 6Ô∏è‚É£ Kembalikan hasil sebagai SATU ITEM (FIXED)\n// Ini adalah array berisi 100 data Anda, dibungkus dalam 1 item n8n.\nreturn [\n  {\n    json: {\n      batch: finalBatchForSupabase // Bungkus array Anda di dalam key, misal 'batch'\n    }\n  }\n];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6848,
        -3680
      ],
      "id": "7a866725-2ac6-440c-8670-b7a117559592",
      "name": "Merged Embeding Result",
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Tentukan ukuran batch\nconst BATCH_SIZE = 100;\n\n// Siapkan array untuk menampung *semua batch* yang akan dikembalikan\nconst outputBatches = [];\n\n// Siapkan array *sementara* untuk batch yang sedang diisi\nlet currentInputs = []; // Key-nya WAJIB 'inputs'\nlet currentSupabaseBatch = []; // Untuk metadata kita\n\n// Ambil data JSON dari node sebelumnya\nconst allData = $input.all();\nconst hotelData = allData[0];\nconst inputData = allData.slice(1);\nconst hotel_id = hotelData.json.data._id;\nconst hotel_name = hotelData.json.data.name;\n\n// Dapatkan ID robota (sesuaikan 'NamaNode' atau 'workflow.variables')\n// Ganti ini dengan path yang benar ke user_robota_id Anda\nconst userRobotaId = $('Upsert Robota Account Data - Supabasev2').first().json.id;\n\n// Lakukan loop untuk setiap review\nfor (const reviews of inputData) {\n  for (const data of reviews.json.data) {\n    const semanticText = `Kata kunci: ${data.review.title}, review: ${data.review.message}`;\n    \n    // --- 1. Tambahkan ke batch Hugging Face ---\n    currentInputs.push(semanticText);\n\n    // --- 2. Tambahkan ke batch Supabase (untuk \"dijodohkan\" nanti) ---\n    const metadata = {\n      hotel_id: hotel_id,\n      hotel_name: hotel_name,\n      rating: data.review.rating,\n      review_date: data.review.date,\n      ota: data.source,\n      sentiment: data.sentiment_general, // Saya perbaiki dari 'data.sentiment.general'\n      user_name: data.user.name\n    };\n    \n    currentSupabaseBatch.push({\n      id: `${data.review.id}`,\n      semanticText: semanticText,\n      metadata: metadata,\n      user_robota_id_fk: userRobotaId\n    });\n\n    // --- 3. Periksa apakah batch sudah penuh ---\n    if (currentInputs.length >= BATCH_SIZE) {\n      // \"Kemas\" batch ini\n      outputBatches.push({\n        json: {\n          // Ini adalah payload yang benar untuk Hugging Face\n          hfPayload: {\n            input: currentInputs,\n            model: \"bge-multilingual-gemma2\"\n          },\n          supabaseData: currentSupabaseBatch\n        }\n      });\n      \n      // Kosongkan array sementara untuk batch berikutnya\n      currentInputs = [];\n      currentSupabaseBatch = [];\n    }\n  }\n}\n\n// --- 4. Tangani sisa review (batch terakhir yang mungkin tidak penuh) ---\nif (currentInputs.length > 0) {\n  outputBatches.push({\n    json: {\n      hfPayload: {\n        input: currentInputs,\n        model: \"bge-multilingual-gemma2\"\n      },\n      supabaseData: currentSupabaseBatch\n    }\n  });\n}\n\n// Kembalikan SEMUA batch yang sudah dikemas\nreturn outputBatches;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7520,
        -3680
      ],
      "id": "4bbb3f8b-f308-4cb2-b98f-d1d8b39292a1",
      "name": "Prepared Text Before Embeding Process",
      "alwaysOutputData": false,
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://ujijqilperkjeyinrkwm.supabase.co/rest/v1/user_robota",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "on_conflict",
              "value": "email"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates, return=representation"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "email",
              "value": "={{ $json.data.user.email }}"
            },
            {
              "name": "token_api",
              "value": "={{ $json.data.access_token }}"
            },
            {
              "name": "refresh_token",
              "value": "={{ $json.data.refresh_token }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -8640,
        -3680
      ],
      "id": "b6012ad1-3395-4fa5-b44f-35705e80da81",
      "name": "Upsert Robota Account Data - Supabasev2",
      "credentials": {
        "supabaseApi": {
          "id": "xpXypIaDFMnlAjAT",
          "name": "Supabase account v2"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "https://ujijqilperkjeyinrkwm.supabase.co/rest/v1/user",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "telegram_chat_id",
              "value": "={{ 'eq.' + $('Login Via Web').item.json.body.tele_id }}"
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_robota_id",
              "value": "={{ $json.id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -8416,
        -3680
      ],
      "id": "d1e71b38-9236-45be-9b86-2917aaf41400",
      "name": "Update User Data - Supabase V2",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "xpXypIaDFMnlAjAT",
          "name": "Supabase account v2"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://router.huggingface.co/scaleway/v1/embeddings",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "huggingFaceApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.hfPayload }}",
        "options": {
          "response": {
            "response": {
              "responseFormat": "json"
            }
          }
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -7296,
        -3680
      ],
      "id": "b83ed101-2446-4a29-b9d9-0c0b0ee022f4",
      "name": "Embedding HuggingFace",
      "credentials": {
        "googlePalmApi": {
          "id": "E8MatmkFvBRm8tSr",
          "name": "Embedding"
        },
        "huggingFaceApi": {
          "id": "VEdWZLFJNn9xU1aR",
          "name": "HuggingFaceApi account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "jsCode": "// Gabungkan semua embedding menjadi satu output saja\nreturn [\n  {\n    json: {\n      id: $json.id,\n      model: $json.model,\n      embeddings: $json.data.map(item => item.embedding)\n    }\n  }\n];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -7072,
        -3680
      ],
      "id": "c7854b6b-8796-40c9-8fa3-4e86c77b0562",
      "name": "Code in JavaScript",
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://ujijqilperkjeyinrkwm.supabase.co/rest/v1/reviews",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json.batch }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -6624,
        -3680
      ],
      "id": "ffe58ab1-c234-435b-80f1-d527db6e54ed",
      "name": "Insert Reviews Data - Supabase V",
      "credentials": {
        "supabaseApi": {
          "id": "xpXypIaDFMnlAjAT",
          "name": "Supabase account v2"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "b0b3217e-3e00-464a-881b-756b618be6ff",
              "leftValue": "={{ $('Upsert Robota Account Data - Supabasev2').item.json.embedding_status }}",
              "rightValue": "={{ $('Upsert Robota Account Data - Supabasev2').item.json.embedding_status }}",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -8192,
        -3680
      ],
      "id": "5c5ffc12-2a03-494c-b6ad-76bcc50ee9c9",
      "name": "isEmbedding?",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user_robota",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('Upsert Robota Account Data - Supabasev2').item.json.id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "embedding_status",
              "fieldValue": "completed"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -6416,
        -3680
      ],
      "id": "b88e47d3-818b-41b0-9e64-17376e47bf8b",
      "name": "Update Status Embeding - Supabase V2",
      "credentials": {
        "supabaseApi": {
          "id": "xpXypIaDFMnlAjAT",
          "name": "Supabase account v2"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "={{ $('Login Via Web').item.json.body.tele_id }}",
        "text": "Mohon maaf anda gagal login",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -8640,
        -3488
      ],
      "id": "5748357e-414c-43a1-a14d-60e762dc0b4b",
      "name": "Send a Failed Login",
      "webhookId": "35dd8484-8c36-45fa-93a6-a20bdfdf89f1",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "={{ $json.telegram_chat_id }}",
        "text": "={{`Selamat Datang ${$json.telegram_username}, Anda sudah berhasil login. Saya chatbot robota ada yang bisa saya bantu?\n\nUntuk mengatur jadwal menerima rangkuman rutin, gunakan:\n/notifikasi [mingguan/bulanan] [hari/tanggal] [jam]`}}\n\ncontoh: \nmingguan:\n\"/notifikasi mingguan senin 7\"\n\n\"/notifikasi bulanan 12 21\"",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -7968,
        -3872
      ],
      "id": "6582b02c-0039-4f6a-8825-bfd6302d0cf8",
      "name": "Send a Successfully Login",
      "webhookId": "41515003-de20-47b1-83c8-94c230f2ae76",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "url": "https://ujijqilperkjeyinrkwm.supabase.co/rest/v1/user_robota",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "select",
              "value": "*, reviews(id,metadata,review_text, user_robota_id,notified_status,embedding_status,updated_at),user(telegram_chat_id))"
            },
            {
              "name": "reviews.metadata->>review_date",
              "value": "=like.{{ $now.minus(186, 'days').format('yyyy-MM-dd') }}*"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -9568,
        -2800
      ],
      "id": "d8b71cd4-defb-40bd-8d96-ed357f2c6849",
      "name": "Get Data User and Reviews- Supabase v",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "xpXypIaDFMnlAjAT",
          "name": "Supabase account v2"
        }
      }
    },
    {
      "parameters": {
        "useCustomSchema": true,
        "tableId": "error_table",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "id_chat",
              "fieldValue": "={{ $json.message.chat.id }}"
            },
            {
              "fieldId": "id_execution",
              "fieldValue": "={{ $json.my_execution_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -6432,
        -1040
      ],
      "id": "3d3c42f2-af13-4109-bec7-5631e3dccba4",
      "name": "Create a row",
      "credentials": {
        "supabaseApi": {
          "id": "rjXvN3szSaBzOfCj",
          "name": "Supabase - edel"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.chat.id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.message_id }}",
        "text": "ü§ñ Sedang memikirkan jawaban atas permintaan Anda",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3584,
        -928
      ],
      "id": "0b2eb71f-9dd2-4558-81b4-e542f160fb58",
      "name": "Edit a Message\"Thinking Process\"1",
      "webhookId": "4a32a373-53e2-4c6a-9625-58d1b63f0dce",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.chat.id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.message_id }}",
        "text": "=‚ö†Ô∏è Maaf {{ $('Telegram Trigger Chatbot').item.json.message.from.first_name }}, saya tidak dapat menemukan informasi yang sesuai dengan kriteria pencarian Anda",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2080,
        -192
      ],
      "id": "6b6b2f76-c98c-4fdc-868c-3d7ce309dffd",
      "name": "Edit a text message7",
      "webhookId": "4a32a373-53e2-4c6a-9625-58d1b63f0dce",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "modelName": "models/gemini-flash-lite-latest",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -3968,
        -736
      ],
      "id": "e7386646-2b03-4f87-9063-e2e08bec2b3c",
      "name": "Google Gemini Chat Model11",
      "credentials": {
        "googlePalmApi": {
          "id": "0Uoi9vQ15TeiYabQ",
          "name": "Google Gemini(PaLM) Api account Chatbot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "//Get Data\nconst metricsData = $('Review Analysis1')?.first()?.json?.metrics || {};\n\n//Footer Metric Output\nconst footer = `\\n\\n<i><b>Sistem menyelesaikan Analisis dengan rincian:</b>\n‚Ä¢ Model: ${metricsData.model_used || 'N/A'}\n‚Ä¢ Respon Time: ${metricsData.response_time || 'N/A'}\n‚Ä¢ Konsumsi Token: ${metricsData.token_breakdown?.total || 'N/A'}\n‚Ä¢ Sisa Token: ${metricsData.remaining_tokens || 'Tidak terbatas'}\n‚Ä¢ Estimasi Cost: ${metricsData.estimated_cost || 'N/A'}</i>`;\n\n//Split text\nconst maxLen = 4000;\nconst longText = $json.response;\nlet items = [];\n\nif (longText && longText.length > 0) {\n    let currentChunk = '';\n    const paragraphs = longText.split('\\n'); \n    \n    for (const paragraph of paragraphs) {\n        if ((currentChunk + paragraph).length < maxLen) {\n            currentChunk += (currentChunk.length > 0 ? '\\n' : '') + paragraph;\n        } else {\n            if (currentChunk.length > 0) {\n                items.push({ json: { text: currentChunk } });\n            }\n            currentChunk = paragraph;\n            \n            // Handle paragraf yang sangat panjang\n            while (currentChunk.length > maxLen) {\n                items.push({ json: { text: currentChunk.substring(0, maxLen) } });\n                currentChunk = currentChunk.substring(maxLen);\n            }\n        }\n    }\n    \n    // Push sisa chunk terakhir\n    if (currentChunk.length > 0) {\n        items.push({ json: { text: currentChunk } });\n    }\n} else {\n    items.push({ json: { text: \"Agent tidak memberikan output.\" } });\n}\n\n// Menambahkan footer ke chunk terakhir\nif (items.length > 0) {\n    let lastIndex = items.length - 1;\n    let lastText = items[lastIndex].json.text || '';\n    \n    if ((lastText.length + footer.length) < 4090) {\n        items[lastIndex].json.text = lastText + footer; \n    } else {\n        items.push({ json: { text: footer } });\n    }\n}\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1856,
        -1632
      ],
      "id": "d75f6372-2d97-4093-84f5-711da28fd995",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -2320,
        -1248
      ],
      "id": "aeceb29e-98da-4a7e-9204-7ff4fff7e3ba",
      "name": "Ollama Chat Model",
      "credentials": {
        "ollamaApi": {
          "id": "f0bMHyaZfjFWLmz1",
          "name": "Ollama account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "items[0].binary.data.fileName = $('Download file').first().json.name+'.pdf' \nreturn items;\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        416,
        -1456
      ],
      "id": "ee38af42-31fc-44a8-8688-d9f8a46a2437",
      "name": "Code2"
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        },
        "options": {
          "binaryPropertyName": "data",
          "googleFileConversion": {
            "conversion": {
              "docsToFormat": "application/pdf"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        224,
        -1456
      ],
      "id": "d9509765-3eb8-4cfa-8092-bd2d7ea655fc",
      "name": "Download file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "TTREbqYStUs8xs4N",
          "name": "Google Drive account chatbot"
        }
      }
    },
    {
      "parameters": {
        "operation": "toText",
        "sourceProperty": "laporanHtml",
        "binaryPropertyName": "file",
        "options": {
          "fileName": "=Laporan Performa Hotel {{ $now.toFormat(\"cccc, d LLLL yyyy\") }}.html"
        }
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        -480,
        -1568
      ],
      "id": "292617b4-86fd-4a62-a01d-56baad10ef78",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "operation": "update",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        },
        "changeFileContent": true,
        "inputDataFieldName": "file",
        "newUpdatedFileName": "=",
        "options": {
          "fields": [
            "id",
            "webViewLink",
            "name"
          ]
        }
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        32,
        -1456
      ],
      "id": "229e042b-1f2a-43ab-addf-794fb018bedc",
      "name": "Update file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "TTREbqYStUs8xs4N",
          "name": "Google Drive account chatbot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const item = $input.item;\n\nif (item.binary && item.binary.file) {\n  item.binary.file.mimeType = 'text/html';\n}\n\nreturn item;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -320,
        -1568
      ],
      "id": "a8c0b3b3-c6b0-4a01-bd73-79342490ef84",
      "name": "Set to text/html"
    },
    {
      "parameters": {
        "operation": "createFromText",
        "content": "file content",
        "name": "=Laporan Performa Hotel {{ $now.toFormat(\"cccc, d LLLL yyyy\") }}",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "1mrHZGzB_Mbj6478IVkOBYfbnS-QL8hHE",
          "mode": "list",
          "cachedResultName": "Dokumen Laporan Review",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1mrHZGzB_Mbj6478IVkOBYfbnS-QL8hHE"
        },
        "options": {
          "convertToGoogleDocument": true
        }
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -480,
        -1360
      ],
      "id": "0ee03b17-1a86-42b7-adf1-82836236d414",
      "name": "Create file from text",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "TTREbqYStUs8xs4N",
          "name": "Google Drive account chatbot"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Ambil semua input items menggunakan sintaks $input.all()\nconst inputItems = $input.all(); \n\n// Cari item yang memiliki raw_stats \nlet langChainItem = inputItems.find(item => item.json && item.json.raw_stats); \n\n// Guard clause untuk memastikan data ada\nif (!langChainItem) {\n    return [{\n        json: {\n            error: 'No valid data found',\n            laporanHtml: '<!DOCTYPE html><html lang=\"id\"><head><title>Error</title><style>body { font-family: sans-serif; padding: 20px; color: #c03b; }</style></head><body><h1>‚ùå Error: Data LangChain Hilang</h1><p>Data LangChain (raw_stats) tidak ada di input node ini.</p></body></html>'\n        }\n    }];\n}\n\n// --- MAPPING DATA LANGCHAIN KE VARIABEL LOKAL ---\nconst data = langChainItem.json;\nconst rawStats = data.raw_stats;\n\n// [PERBAIKAN 1: DATA UTAMA DIAMBIL LANGSUNG DARI JSON]\nconst fullReportContent = data.report_content || '';\nconst analisisPerOta = rawStats.platforms || [];\nconst globalSentiment = rawStats.global_sentiment || 'N/A';\nconst globalRating = rawStats.global_rating || 'N/A';\nconst totalReviews = rawStats.total_reviews_global || 'N/A';\nlet rekomendasiKeseluruhan = rawStats.global_recommendations || [];\nconst analysisPeriodRaw = data.date; \n\n// [PERBAIKAN 2: MAPPING VARIABLE YANG DIMINTA]\n// Mengambil langsung dari root object JSON LangChain (bukan fungsi hardcoded)\nconst analysisPeriodDisplay = data.analysis_period || \"Periode Tidak Terdeteksi\";\nconst reportCreator = data.requested_by || \"RoboAI System\";\nconst summaryText = rawStats.executive_summary || \"Ringkasan eksekutif tidak tersedia.\";\nconst trendText = rawStats.overall_trend || \"Tren keseluruhan tidak tersedia.\";\n\n\n// --- HELPER ---\n\nfunction escapeHtml(text) {\n    if (!text) return '';\n    return text.toString()\n        .replace(/&/g, '&amp;')\n        .replace(/</g, '&lt;')\n        .replace(/>/g, '&gt;')\n        .replace(/\"/g, '&quot;')\n        .replace(/'/g, '&#039;');\n}\n\nfunction formatCreationDate(dateString) {\n    const date = dateString ? new Date(dateString) : new Date();\n    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };\n    return date.toLocaleDateString('id-ID', options); // Ubah ke format Indonesia\n}\n\n// Fungsi helper lama dihapus karena data sudah diambil langsung di atas\n// (getPeriodDisplay, extractExecutiveSummary, extractTrendText -> DIHAPUS)\n\nfunction generateGlobalRecsFallback(platformsData, existingRecs) {\n    if (existingRecs.length > 0 && existingRecs[0] !== 'Tidak ada rekomendasi global.') return existingRecs;\n    \n    const topIssues = [];\n    platformsData.forEach(p => {\n        p.problems.forEach(issue => {\n            if (issue.urgency === 'Mendesak' || issue.urgency === 'Tinggi') {\n                topIssues.push(`Prioritas pada perbaikan ${issue.issue} di ${p.name}.`);\n            }\n        });\n    });\n    \n    const uniqueRecs = [...new Set(topIssues)];\n    return uniqueRecs.slice(0, 3).length > 0 ? uniqueRecs.slice(0, 3) : ['Tingkatkan standar operasional dan pemeliharaan rutin.'];\n}\n\nfunction generateChartData(platformsData) {\n    const otaLabels = platformsData.map(p => p.name);\n    const reviewCounts = platformsData.map(p => p.total_reviews);\n    \n    let sentimentCounts = { Positif: 0, Negatif: 0, Campuran: 0 };\n    platformsData.forEach(p => {\n        // Normalisasi kapitalisasi sentimen\n        let s = p.sentiment ? p.sentiment.charAt(0).toUpperCase() + p.sentiment.slice(1).toLowerCase() : 'Campuran';\n        if (!sentimentCounts.hasOwnProperty(s)) s = 'Campuran';\n        sentimentCounts[s] = (sentimentCounts[s] || 0) + p.total_reviews;\n    });\n\n    return {\n        otaLabels: otaLabels,\n        reviewCounts: reviewCounts,\n        sentimentLabels: Object.keys(sentimentCounts),\n        sentimentCounts: Object.values(sentimentCounts)\n    };\n}\n\nfunction generateQuickChartUrl(chartType, labels, data, title) {\n    const chartConfig = {\n        type: chartType,\n        data: {\n            labels: labels,\n            datasets: [{\n                label: title,\n                data: data,\n                backgroundColor: ['#16a085', '#e74c3c', '#f39c12', '#3498db'], \n                borderColor: 'rgba(0,0,0,0.1)',\n                borderWidth: 1\n            }]\n        },\n        options: {\n            title: { display: true, text: title, fontSize: 10 },\n            legend: { display: (chartType !== 'bar'), position: 'bottom', labels: { fontSize: 8 } },\n            scales: {\n                yAxes: [{ ticks: { beginAtZero: true, fontSize: 8, precision: 0 } }],\n                xAxes: [{ ticks: { fontSize: 8, maxRotation: 45 } }]\n            }\n        }\n    };\n    return `https://quickchart.io/chart?c=${encodeURIComponent(JSON.stringify(chartConfig))}&w=300&h=200&bkg=white&devicePixelRatio=2`;\n}\n\nfunction generateCustomerFeedbackTable(platformsData) {\n    let tableRows = '';\n    let consolidatedIssues = [];\n\n    platformsData.forEach(p => {\n        const otaName = p.name;\n        if (p.problems && Array.isArray(p.problems)) {\n            p.problems.forEach(issue => {\n                consolidatedIssues.push({ ota: otaName, masalah: issue.issue, frekuensi: issue.frequency, urgency: issue.urgency });\n            });\n        }\n    });\n\n    const urgencyOrder = [\"Mendesak\", \"Tinggi\", \"Sedang\", \"Rendah\", \"Aman\", \"Info\"];\n    consolidatedIssues.sort((a, b) => urgencyOrder.indexOf(a.urgency) - urgencyOrder.indexOf(b.urgency));\n\n\n    consolidatedIssues.forEach(item => {\n        tableRows += `\n            <tr>\n                <td>${escapeHtml(item.ota)}</td>\n                <td>${escapeHtml(item.masalah)}</td>\n                <td>${escapeHtml(item.frekuensi)}</td>\n                <td style=\"font-weight: bold; color: ${item.urgency === 'Mendesak' ? 'red' : item.urgency === 'Tinggi' ? 'orange' : 'black'};\">${escapeHtml(item.urgency)}</td>\n            </tr>\n        `;\n    });\n\n    if (consolidatedIssues.length === 0) return \"<p>Tidak ada masalah signifikan yang terdeteksi.</p>\";\n    return `\n        <table style=\"width:100%; border-collapse: collapse;\">\n            <thead>\n                <tr style=\"background-color: #f4f4f4;\">\n                    <th style=\"border: 1px solid #ddd; padding: 12px;\">Platform/OTA</th>\n                    <th style=\"border: 1px solid #ddd; padding: 12px;\">Topik Masalah</th>\n                    <th style=\"border: 1px solid #ddd; padding: 12px;\">Frekuensi</th>\n                    <th style=\"border: 1px solid #ddd; padding: 12px;\">Urgency</th>\n                </tr>\n            </thead>\n            <tbody>\n                ${tableRows}\n            </tbody>\n        </table>\n    `;\n}\n\n// 10. Generate OTA Analysis\nfunction generateOtaAnalysis(platformsData) {\n    let html = '';\n    platformsData.forEach((p, index) => {\n        const otaTrendSummary = p.trend_summary_ota || '[Ringkasan tren platform tidak tersedia.]';\n\n        html += `\n            <div style=\"margin-bottom: 30px; border-left: 4px solid #007bff; padding: 15px; background: #f9f9f9; border-radius: 4px;\">\n                <h3 style=\"margin-top: 0;\">${index + 1}. Platform: <b>${escapeHtml(p.name || 'Unknown')}</b></h3>\n                \n                <p><strong>Tren Analisis:</strong> ${escapeHtml(otaTrendSummary)}</p>\n                \n                <table style=\"width: 100%; margin-bottom: 15px;\">\n                    <tbody>\n                        <tr><td style=\"border: 1px solid #ddd; padding: 10px;\"><strong>Jumlah Review:</strong></td><td style=\"border: 1px solid #ddd; padding: 10px;\">${escapeHtml(p.total_reviews || 0)} ulasan</td></tr>\n                        <tr><td style=\"border: 1px solid #ddd; padding: 10px;\"><strong>Rating Rata-rata:</strong></td><td style=\"border: 1px solid #ddd; padding: 10px;\">${escapeHtml(p.average_rating || 'N/A')}</td></tr>\n                        <tr><td style=\"border: 1px solid #ddd; padding: 10px;\"><strong>Sentimen:</strong></td><td style=\"border: 1px solid #ddd; padding: 10px;\">${escapeHtml(p.sentiment || 'N/A')}</td></tr>\n                    </tbody>\n                </table>\n                \n                <h4 style=\"color: #16a085;\">Hal Positif:</h4>\n                <ul style=\"margin-top: 5px;\">\n                    ${(p.pros && p.pros.length > 0) ? p.pros.map(pro => `<li>${escapeHtml(pro)}</li>`).join('') : '<li><em>Tidak ada data.</em></li>'}\n                </ul>\n                \n                </div>\n        `;\n    });\n    return html;\n}\n\n// --- EXECUTE TEMPLATE ---\n\nconst chartDataProcessed = generateChartData(analisisPerOta);\nconst finalGlobalRecs = generateGlobalRecsFallback(analisisPerOta, rekomendasiKeseluruhan);\nconst creationDateDisplay = formatCreationDate(analysisPeriodRaw);\n\n// Inisialisasi HTML laporan (STYLE ASLI)\nlet reportHtml = `<!DOCTYPE html>\n<html lang=\"id\">\n<head>\n<meta charset=\"UTF-8\" />\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n<title>Laporan Performa Hotel</title>\n<style>\n    body { font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, Helvetica, Arial, sans-serif; line-height: 1.6; background-color: #fff; color: #212529; margin: 0; padding: 0; }\n    .container { max-width: 900px; margin: 20px auto; padding: 30px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }\n    h1, h2, h3, h4 { margin-top: 0; }\n    h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; font-size: 1.8em; }\n    h2 { color: #16a085; border-bottom: 2px solid #eee; padding-bottom: 8px; margin-top: 40px; }\n    h3 { color: #2980b9; margin-top: 30px; }\n    h4 { color: #34495e; margin-top: 20px; }\n    p { margin-bottom: 15px; }\n    hr { border: none; height: 1px; background: #ddd; margin: 40px 0; }\n    table { width: 100%; border-collapse: collapse; margin: 20px 0; }\n    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }\n    th { background: #f4f4f4; font-weight: bold; }\n    tr:nth-child(even) { background: #f9f9f9; }\n    ul, ol { padding-left: 30px; }\n    li { margin-bottom: 8px; }\n    .footer-note { text-align: center; font-style: italic; color: #888; font-size: 0.9em; margin-top: 30px; }\n    .chart-placeholder { height: 300px; border: 1px dashed #ccc; display: flex; align-items: center; justify-content: center; margin: 20px 0; background: #f9f9f9; }\n</style>\n</head>\n<body>\n<div class=\"container\">\n`;\n\n// 1, 2, 3, 4: JUDUL & METADATA (DIPERBAIKI)\nreportHtml += `<h1 style=\"color: #2c3e50; text-align: center; margin-bottom: 20px; font-size: 1.8em; font-weight: bold;\">LAPORAN PERFORMA HOTEL</h1>\\n`;\n\nreportHtml += `<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"width: 100%; margin-bottom: 30px; background: #fdfdfd; border-radius: 5px; border: 1px solid #eee;\">\n    <tr>\n        <td style=\"border: none; padding: 20px; text-align: left;\">\n            <p style=\"margin: 5px 0; font-size: 0.95em; color: #555;\"><strong>Tanggal Pembuatan Laporan:</strong> ${escapeHtml(creationDateDisplay)}</p>\n            <p style=\"margin: 5px 0; font-size: 0.95em; color: #555;\"><strong>Periode Laporan:</strong> ${escapeHtml(analysisPeriodDisplay)}</p>\n            <p style=\"margin: 5px 0; font-size: 0.95em; color: #555;\"><strong>Pembuat Laporan:</strong> ${escapeHtml(reportCreator)}</p>\n        </td>\n    </tr>\n</table>\\n<hr>\\n`;\n\n// 5. Rangkuman Keseluruhan (DIPERBAIKI - Variabel summaryText)\nreportHtml += `<h2>Rangkuman Keseluruhan</h2>\\n<p>${escapeHtml(summaryText)}</p>\\n<hr>\\n`; \n\n// 6. Analisis Sentimen Pelanggan (DIPERBAIKI - Variabel trendText)\nreportHtml += `<h2>Analisis Sentimen Pelanggan</h2>\\n`;\nreportHtml += `<p><strong>Status Sentimen:</strong> ${escapeHtml(globalSentiment)}</p>`;\nreportHtml += `<p><strong>Total Ulasan Seluruh OTA:</strong> ${escapeHtml(totalReviews)} ulasan</p>`;\nreportHtml += `<h3>Tren Sentimen:</h3>\\n<p>${escapeHtml(trendText)}</p>\\n<hr>\\n`;\n\n// 7. Visualisasi (Chart)\nreportHtml += `<h2>Visualisasi dari Analisis Sentimen</h2>\\n`;\nreportHtml += `<p>Visualisasi berikut perlu ditambahkan di tahap PDF Rendering (Node selanjutnya):</p>\\n`;\nreportHtml += `<div style=\"display: flex; justify-content: space-around; flex-wrap: wrap;\">`;\n\n// Chart 1: Review Counts per OTA (Bar Chart)\nreportHtml += `<img src=\"${generateQuickChartUrl('bar', chartDataProcessed.otaLabels, chartDataProcessed.reviewCounts, 'Jumlah Review per OTA')}\" alt=\"Review Counts per OTA\" style=\"width:45%; margin: 10px 0;\">`;\n\n// Chart 2: Sentiment Distribution (Doughnut Chart)\nreportHtml += `<img src=\"${generateQuickChartUrl('doughnut', chartDataProcessed.sentimentLabels, chartDataProcessed.sentimentCounts, 'Distribusi Sentimen Global')}\" alt=\"Sentiment Distribution\" style=\"width:45%; margin: 10px 0;\">`;\n\nreportHtml += `</div>\\n<hr>\\n`;\n\n// 8. Analisis Detail per Platform (OTA)\nreportHtml += `<h2>Analisis Detail per Platform (OTA)</h2>\\n`;\nreportHtml += generateOtaAnalysis(analisisPerOta);\nreportHtml += `<hr>\\n`;\n\n// 9. Customer Feedback (Table)\nreportHtml += `<h2>Customer Feedback</h2>\\n<p>Berikut adalah umpan balik yang memerlukan perhatian dan tindakan segera:</p>\\n`;\nreportHtml += generateCustomerFeedbackTable(analisisPerOta);\nreportHtml += `<hr>\\n`;\n\n// 10. Rekomendasi Strategis\nreportHtml += `<h2>Rekomendasi Strategis</h2>\\n`;\n\n// Menggunakan finalGlobalRecs\nreportHtml += `<h3>A. Rekomendasi Global</h3>\\n`;\nreportHtml += `<ul>${finalGlobalRecs.map(rec => `<li>${escapeHtml(rec)}</li>`).join('') || '<li>Tidak ada rekomendasi global.</li>'}</ul>\\n`;\n\nreportHtml += `<h3>B. Rekomendasi per Platform</h3>\\n`;\n\nif (analisisPerOta.length > 0) {\n    analisisPerOta.forEach(p => {\n        reportHtml += `<p><strong>${escapeHtml(p.name || 'Platform OTA')}:</strong></p>`;\n        \n        if (p.local_recommendations && p.local_recommendations.length > 0) {\n            reportHtml += `<ul>`;\n            p.local_recommendations.forEach(r => {\n                reportHtml += `<li>${escapeHtml(r)}</li>`;\n            });\n            reportHtml += `</ul>`;\n        } else {\n            reportHtml += `<ul><li><em>Tidak ada rekomendasi aksi khusus untuk platform ini.</em></li></ul>`;\n        }\n    });\n} else {\n    reportHtml += `<p><em>Tidak ada data rekomendasi OTA tersedia.</em></p>`;\n}\nreportHtml += `<hr>\\n`;\n\n// Footer\nreportHtml += `<h2>Catatan Penutup</h2>\\n`;\nreportHtml += `<p>Laporan ini disusun berdasarkan analisis mendalam terhadap ulasan pelanggan dari berbagai platform OTA. Implementasi rekomendasi yang tercantum diharapkan dapat meningkatkan kepuasan pelanggan dan performa hotel secara keseluruhan.</p>\\n`;\nreportHtml += `<p class=\"footer-note\"><em>Laporan ini bersifat rahasia dan hanya untuk keperluan internal.</em></p>\\n`;\n\n// Tutup body dan html\nreportHtml += `</div></body></html>`;\n\n// Return hasil\nreturn [{\n    json: {\n        laporanHtml: reportHtml,\n        fileName: `Laporan_Hotel_${new Date().toISOString().substring(0, 10).replace(/-/g, '_')}.html`,\n        mimeType: 'text/html'\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -672,
        -1472
      ],
      "id": "d9a4b5f2-f671-4645-9f38-0aa683a40af0",
      "name": "Create Report1"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Trigger Chatbot').first().json.message.chat.id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -1824,
        -416
      ],
      "id": "8f79ad40-ad7f-42b4-a256-08a388a68a81",
      "name": "Postgres Chat Memory9",
      "credentials": {
        "postgres": {
          "id": "6Wmt8YnExFDqKOII",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOllama",
      "typeVersion": 1,
      "position": [
        -2144,
        -576
      ],
      "id": "dcf8f53c-4b4d-4d40-a3ea-0720ea0d0a6b",
      "name": "Ollama Chat Model3",
      "credentials": {
        "ollamaApi": {
          "id": "f0bMHyaZfjFWLmz1",
          "name": "Ollama account 2"
        }
      }
    },
    {
      "parameters": {
        "code": {
          "execute": {
            "code": "const { PromptTemplate } = require('@langchain/core/prompts');\nconst { RunnableSequence } = require('@langchain/core/runnables');\nconst { StringOutputParser } = require('@langchain/core/output_parsers');\n\n//Pricing\nconst PRICING_DB = {\n    'gemini': { input: 0.30 / 1000000, output: 2.50 / 1000000 },\n    'llama':  { input: 0, output: 0 },\n    'ollama': { input: 0, output: 0 },\n    'default': { input: 0, output: 0 }\n};\nconst USD_TO_IDR = 16500;\nconst TOKEN_LIMIT_CONFIG = 1000000; \n\nconst metrics = {\n    startTime: Date.now(),\n    tokenUsage: { input: 0, output: 0, total: 0 },\n    llmCalls: 0,\n    modelsUsed: { primary: null, fallback: null, active: null, fallback_triggered: false },\n    errors: []\n};\n\n//Fungsi Metric Model\n\nfunction getModelInfo(llmObject) {\n    const rawName = llmObject.modelName || llmObject.model || \"Unknown-Model\";\n    const lowerName = rawName.toLowerCase();\n    \n    let pricing = PRICING_DB.default;\n    let typeKey = 'default';\n    \n    if (lowerName.includes('flash') || lowerName.includes('gemini')) {\n        pricing = PRICING_DB.gemini;\n        typeKey = 'gemini';\n    } else if (lowerName.includes('llama') || lowerName.includes('ollama')) {\n        pricing = PRICING_DB.llama;\n        typeKey = 'llama';\n    } else if (lowerName.includes('gpt')) {\n        pricing = PRICING_DB.openai;\n        typeKey = 'openai';\n    }\n\n    return { name: rawName, pricing: pricing, type: typeKey };\n}\n\n//Fungsi token usage\nfunction trackTokens(response, modelType, inputLen = 0, outputLen = 0) {\n    let input = 0, output = 0;\n\n    if (response?.response_metadata) {\n        const meta = response.response_metadata;\n        if (meta.usage) { \n            input = meta.usage.prompt_tokens || meta.usage.input_tokens || 0;\n            output = meta.usage.completion_tokens || meta.usage.output_tokens || 0;\n        } else if (meta.prompt_eval_count !== undefined) { \n            input = meta.prompt_eval_count || 0;\n            output = meta.eval_count || 0;\n        }\n    } else if (response?.usage) {\n        input = response.usage.input_tokens || 0;\n        output = response.usage.output_tokens || 0;\n    } else {\n        if (inputLen > 0) input = Math.ceil(inputLen / 3.5);\n        if (outputLen > 0) output = Math.ceil(outputLen / 3.5);\n    }\n\n    metrics.tokenUsage.input += input;\n    metrics.tokenUsage.output += output;\n    metrics.tokenUsage.total += (input + output);\n    metrics.llmCalls++;\n}\n\n// fungsi laporan metric\nfunction getMetricsReport() {\n    const duration = Date.now() - metrics.startTime;\n    \n    let activePricing = PRICING_DB.default;\n    if (metrics.modelsUsed.active) {\n        const lowerName = metrics.modelsUsed.active.toLowerCase();\n        if (lowerName.includes('gemini') || lowerName.includes('flash')) activePricing = PRICING_DB.gemini;\n        else if (lowerName.includes('gpt')) activePricing = PRICING_DB.openai;\n    }\n\n    const costUsd = (metrics.tokenUsage.input * activePricing.input) + \n                    (metrics.tokenUsage.output * activePricing.output);\n    const costIdr = costUsd * USD_TO_IDR;\n\n    return {\n        response_time_seconds: (duration / 1000).toFixed(2),\n        token_usage: {\n            total_tokens: metrics.tokenUsage.total,\n            input: metrics.tokenUsage.input,\n            output: metrics.tokenUsage.output\n        },\n        estimated_cost: {\n            usd: costUsd.toFixed(6),\n            idr: `Rp ${Math.ceil(costIdr)}`\n        },\n        models_used: {\n            active_model: metrics.modelsUsed.active,\n            fallback_triggered: metrics.modelsUsed.fallback_triggered\n        }\n    };\n}\n\n//fungsi cek token error\nconst isQuotaError = (error) => {\n    const msg = (error.message || \"\").toLowerCase();\n    return error.status === 429 || error.status === 503 || \n           msg.includes(\"quota\") || msg.includes(\"rate_limit\") || msg.includes(\"overloaded\") || msg.includes(\"resource_exhausted\");\n};\n\nconst returnError = (message, chatId = null) => {\n    metrics.errors.push(message);\n    return [{\n        json: {\n            type: \"error_notification\",\n            error: message, \n            chat_id: chatId,\n            metrics: getMetricsReport()\n        }\n    }];\n};\n\n//fungsi notifikasi fallback \nconst createFallbackNotification = (fromModel, toModel, reason, chatId) => {\n    return {\n        type: \"chat_response\",\n        response: `<b>NOTIFIKASI PERGANTIAN MODEL</b>\\n\\n` +\n                  `<b>Status:</b> Model utama mengalami masalah\\n` +\n                  `<b>Model Awal:</b> ${fromModel}\\n` +\n                  `<b>Model Pengganti:</b> ${toModel}\\n` +\n                  `<b>Alasan:</b> ${reason}\\n\\n` +\n                  `Proses analisis akan dilanjutkan menggunakan model pengganti.`,\n        chat_id: chatId,\n        is_fallback_notification: true\n    };\n};\n\n// inisiasi LLM model\nlet primaryLLM, fallbackLLM;\nlet primaryInfo, fallbackInfo;\n\ntry {\n    const [primary, fallback] = await Promise.all([\n        this.getInputConnectionData('ai_languageModel', 0),\n        this.getInputConnectionData('ai_languageModel', 1).catch(() => null)\n    ]);\n    \n    primaryLLM = primary?.[0];\n    fallbackLLM = fallback?.[0] || null;\n    \n    if (!primaryLLM) {\n        return returnError(\"Primary LLM tidak terkonfigurasi\");\n    }\n    \n    primaryInfo = getModelInfo(primaryLLM);\n    metrics.modelsUsed.primary = primaryInfo.name;\n    metrics.modelsUsed.active = primaryInfo.name; \n    \n    if (fallbackLLM) {\n        fallbackInfo = getModelInfo(fallbackLLM);\n        metrics.modelsUsed.fallback = fallbackInfo.name;\n    }\n    \n} catch (error) {\n    return returnError(`Gagal inisialisasi LLM: ${error.message}`);\n}\n\n//Data processing\nlet capturedChatId, extractedInfo, formattedReviews, reviewsData, dataPeriod;\n\ntry {\n    const inputItems = this.getInputData();\n    \n    if (inputItems.length === 0) return returnError(\"Tidak ada data input.\");\n    \n    const firstItem = inputItems[0].json;\n\n    // Mengambil pertanyaan user\n    let userQuery = \"\";\n    try {\n        const triggerData = $('Telegram Trigger Chatbot').first();\n        if (triggerData && triggerData.json && triggerData.json.message) {\n            userQuery = triggerData.json.message.text;\n        }\n    } catch (err) {}\n\n    if (!userQuery) {\n        userQuery = firstItem.original_query || \n                    firstItem.query || \n                    firstItem.message?.text || \n                    \"Analisis data ini.\";\n    }\n\n    // 2. Mengambil periode (start_date & end_date)\n    let startDate = null;\n    let endDate = null;\n   \n    try {\n        const extractorData = $('Information Extractor').item.json;\n        if (extractorData?.output?.start_date && extractorData?.output?.end_date) {\n            startDate = extractorData.output.start_date;\n            endDate = extractorData.output.end_date;\n        }\n    } catch (err) {\n    }\n    \n    if (!startDate || !endDate) {\n        if (firstItem.start_date && firstItem.end_date) {\n            startDate = firstItem.start_date;\n            endDate = firstItem.end_date;\n        } else if (firstItem.output?.start_date && firstItem.output?.end_date) {\n            startDate = firstItem.output.start_date;\n            endDate = firstItem.output.end_date;\n        }\n    }\n    \n    if (!startDate || !endDate) {\n        for (const item of inputItems) {\n            if (item.json?.metadata?.start_date && item.json?.metadata?.end_date) {\n                startDate = item.json.metadata.start_date;\n                endDate = item.json.metadata.end_date;\n                break;\n            }\n        }\n    }\n    \n    if (startDate && endDate) {\n        dataPeriod = `${startDate} hingga ${endDate}`;\n    } else {\n        const now = new Date();\n        const monthNames = [\"Januari\", \"Februari\", \"Maret\", \"April\", \"Mei\", \"Juni\",\n                           \"Juli\", \"Agustus\", \"September\", \"Oktober\", \"November\", \"Desember\"];\n        dataPeriod = `${monthNames[now.getMonth()]} ${now.getFullYear()}`;\n    }\n\n    // 3. Menentukan tools\n    let agentType = firstItem.agent || \"qa\"; \n    \n    if (!firstItem.agent) {\n        const lowerQuery = userQuery.toLowerCase();\n        if (lowerQuery.includes(\"berapa\") || lowerQuery.includes(\"jumlah\") || lowerQuery.includes(\"rata-rata\") || lowerQuery.includes(\"persen\")) {\n            agentType = \"stats\";\n        }\n    }\n\n    extractedInfo = { \n        original_query: userQuery,\n        agent_type: agentType,\n        data_period: dataPeriod\n    };\n\n    // 4. Mengambil chat id\n    capturedChatId = firstItem.chat_id || \n                     firstItem.message?.chat?.id || \n                     firstItem.body?.message?.chat?.id;\n    if (!capturedChatId) {\n        try { capturedChatId = $('Telegram Trigger Chatbot').first().json.message.chat.id; } catch (e) {}\n    }\n\n    // 5. Memproses data\n    if (firstItem.total_reviews && firstItem.by_ota) {\n        reviewsData = [firstItem]; \n        formattedReviews = JSON.stringify(firstItem, null, 2);\n    } else {\n        const isPureReviews = firstItem.review_text !== undefined || firstItem.similarity !== undefined;\n        if (isPureReviews) {\n            reviewsData = inputItems.map(item => item.json);\n        } else {\n            reviewsData = inputItems.slice(1).map(item => item.json);\n        }\n        \n        formattedReviews = reviewsData.map((review, index) => {\n            const text = review.review_text || review.message || JSON.stringify(review);\n            const meta = review.source ? `(${review.source})` : ''; \n            const rating = review.rating ? `[Rating: ${review.rating}]` : '';\n            const reviewDate = review.metadata?.review_date ? `[${review.metadata.review_date}]` : '';\n            return `‚Ä¢ ${text} ${meta} ${rating} ${reviewDate}`;\n        }).join('\\n');\n    }\n\n    if (!formattedReviews || reviewsData.length === 0) {\n         return returnError(\"Data tidak tersedia untuk menjawab pertanyaan ini.\", capturedChatId);\n    }\n\n} catch (error) {\n    return returnError(`Gagal memproses input: ${error.message}`, capturedChatId);\n}\n\n// Prompt Agent\n\nlet finalPrompt;\n\nif (extractedInfo.agent_type === \"stats\") {\n    finalPrompt = PromptTemplate.fromTemplate(`\nAnda adalah Analis Data Hotel. Tugas Anda adalah menjawab pertanyaan statistik dengan format HTML yang rapi untuk Telegram.\n\nKONTEKS PENTING:\n- Data yang dianalisis adalah dari periode: <b>{period}</b>\n- Jika pertanyaan user menyebut bulan/periode tertentu, SELALU rujuk ke periode ini\n- Jangan asumsi periode lain kecuali data period menunjukkan sebaliknya\n\nPERTANYAAN: \"{question}\"\n\nDATA (JSON/Text):\n\"\"\"\n{reviews}\n\"\"\"\n\nINSTRUKSI JAWABAN:\n1. Jawab langsung dengan ANGKA atau FAKTA UTAMA.\n2. SELALU sebutkan periode data di awal jawaban jika relevan.\n3. FORMAT JAWABAN WAJIB HTML (Telegram):\n   - Gunakan tag <b>...</b> untuk menebalkan angka penting atau judul.\n   - Gunakan tag <code>...</code> untuk menyorot nilai persentase atau angka spesifik.\n   - Gunakan simbol bullet (‚Ä¢) manual untuk list.\n   - JANGAN gunakan format Markdown (seperti **bold** atau \\`code\\`).\n   - JANGAN gunakan tag <p>, <br>, <ul>, <li>. Gunakan Enter biasa untuk baris baru.\n\nCONTOH OUTPUT:\n\"Berdasarkan data periode <b>{period}</b>, rata-rata rating adalah <b>8.5/10</b>.\nRincian per platform:\n‚Ä¢ Agoda: <code>9.0</code>\n‚Ä¢ Traveloka: <code>8.2</code>\"\n\nJAWABAN:\n`);\n\n} else {\n    finalPrompt = PromptTemplate.fromTemplate(`\nAnda adalah Konsultan Analisis Hotel. Tugas Anda adalah menjawab pertanyaan spesifik user dengan format HTML untuk Telegram.\n\nKONTEKS PENTING:\n- Data ulasan yang Anda analisis adalah dari periode: <b>{period}</b>\n- Jika user bertanya tentang suatu bulan/periode, jawab berdasarkan periode ini\n- Semua ulasan di bawah adalah dari periode tersebut\n\nPERTANYAAN USER: \"{question}\"\n\nDATA ULASAN (Periode: {period}):\n\"\"\"\n{reviews}\n\"\"\"\n\nINSTRUKSI PENTING:\n1. **Analisis Topik Spesifik:sesuai konteks pertanyaan user\n2. **Konteks Waktu:** Jika pertanyaan menyebut bulan/tanggal tertentu, SELALU rujuk ke periode data ({period}).\n3. **Format Jawaban WAJIB HTML (Telegram):**\n   - Gunakan tag <b>...</b> untuk menebalkan poin utama.\n   - Gunakan tag <i>...</i> untuk penekanan ringan.\n   - Jangan Gunakan Emoji\n   - Gunakan simbol bullet (‚Ä¢) untuk daftar.\n   - JANGAN gunakan format Markdown (seperti **bold**).\n   - JANGAN gunakan tag <p>, <br>, <h1>. Gunakan Enter biasa untuk baris baru.\n\n4. **Struktur:**\n   - Mulai dengan kesimpulan singkat yang menyebutkan periode jika relevan.\n   - Ikuti dengan poin-poin detail.\n\nJAWABAN ANDA (Dalam HTML):\n`);\n}\n\n// Eksekusi Prompt\nlet qaAnswer;\nlet fallbackNotificationObj = null;\n\ntry {\n    const chain = RunnableSequence.from([finalPrompt, primaryLLM, new StringOutputParser()]);\n    \n    const promptInput = {\n        question: extractedInfo.original_query,\n        reviews: formattedReviews,\n        period: extractedInfo.data_period\n    };\n    const promptLength = JSON.stringify(promptInput).length;\n\n    const result = await chain.invoke(promptInput);\n    qaAnswer = result;\n    \n    trackTokens(result, primaryInfo.type, promptLength, qaAnswer.length);\n\n} catch (error) {\n    if (isQuotaError(error) && fallbackLLM) {\n        \n        const errorReason = error.message.includes('quota') ? 'Kuota API habis' : 'Gangguan koneksi';\n        fallbackNotificationObj = createFallbackNotification(\n           metrics.modelsUsed.primary,\n           metrics.modelsUsed.fallback,\n           errorReason,\n           capturedChatId\n        );\n        \n        metrics.modelsUsed.fallback_triggered = true;\n        metrics.modelsUsed.active = fallbackInfo.name;\n        \n        try {\n            const fallbackChain = RunnableSequence.from([finalPrompt, fallbackLLM, new StringOutputParser()]);\n            \n            const promptInput = {\n                question: extractedInfo.original_query,\n                reviews: formattedReviews,\n                period: extractedInfo.data_period\n            };\n            const promptLength = JSON.stringify(promptInput).length;\n\n            const result = await fallbackChain.invoke(promptInput);\n            qaAnswer = result;\n            \n            trackTokens(result, fallbackInfo.type, promptLength, qaAnswer.length);\n            \n        } catch (fbError) {\n            return returnError(`Fallback model gagal: ${fbError.message}`, capturedChatId);\n        }\n    } else {\n        return returnError(`Q&A gagal: ${error.message}`, capturedChatId);\n    }\n}\n\n// Menampilkan output\n\nif (typeof qaAnswer === 'string') {\n    qaAnswer = qaAnswer\n        .replace(/```html\\n?/g, '') \n        .replace(/```\\n?/g, '')\n        .replace(/\\*\\*(.*?)\\*\\*/g, '<b>$1</b>')\n        .replace(/`(.*?)`/g, '<code>$1</code>')\n        .replace(/<p>/g, '')      \n        .replace(/<\\/p>/g, '\\n')\n        .trim();\n}\n\nif (!qaAnswer || qaAnswer.length < 5) {\n    return returnError(\"Jawaban kosong/terlalu pendek.\", capturedChatId);\n}\n\nconst finalMetrics = getMetricsReport();\nconst outputs = [];\n\nif (fallbackNotificationObj) {\n    outputs.push({ json: fallbackNotificationObj });\n}\n\n// 2. Identifikasi output yagn akan dikeluarkan\noutputs.push({\n    json: {\n        type: \"chat_response\",\n        response: qaAnswer,\n        chat_id: capturedChatId,\n        agent: extractedInfo.agent_type,\n        query: extractedInfo.original_query,\n        data_period: extractedInfo.data_period,\n        reviews_analyzed: reviewsData.length,\n        metrics: {\n            response_time: finalMetrics.response_time_seconds + 's',\n            tokens_used: finalMetrics.token_usage.total_tokens,\n            estimated_cost: finalMetrics.estimated_cost.idr,\n            model_used: finalMetrics.models_used.active_model,\n            remaining_tokens: Math.max(0, TOKEN_LIMIT_CONFIG - finalMetrics.token_usage.total_tokens),\n            fallback_triggered: finalMetrics.models_used.fallback_triggered\n        }\n    }\n});\n\nreturn outputs;"
          }
        },
        "inputs": {
          "input": [
            {
              "type": "main"
            },
            {
              "type": "ai_languageModel"
            },
            {
              "type": "ai_languageModel"
            },
            {
              "type": "ai_memory"
            }
          ]
        },
        "outputs": {
          "output": [
            {
              "type": "main"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.code",
      "typeVersion": 1,
      "position": [
        -2016,
        -736
      ],
      "id": "68c1db23-2ae9-4011-a112-1103fe98dbfa",
      "name": "q&a1"
    },
    {
      "parameters": {
        "operation": "sendDocument",
        "chatId": "={{ $('Telegram Trigger Chatbot').first().json.message.chat.id }}",
        "binaryData": true,
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        656,
        -1344
      ],
      "id": "d54fea77-d233-4519-ac4a-1de690f5f121",
      "name": "Send a document1",
      "webhookId": "f2faa3ea-c04e-40e3-a70c-071cc94e7b97",
      "alwaysOutputData": false,
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -2128,
        -1168
      ],
      "id": "da823278-7d3a-4676-96a2-dc4b9414d7e7",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "0Uoi9vQ15TeiYabQ",
          "name": "Google Gemini(PaLM) Api account Chatbot"
        }
      }
    },
    {
      "parameters": {
        "code": {
          "execute": {
            "code": "const { PromptTemplate } = require('@langchain/core/prompts');\nconst { RunnableSequence } = require('@langchain/core/runnables');\nconst { JsonOutputParser } = require('@langchain/core/output_parsers');\nconst { StringOutputParser } = require('@langchain/core/output_parsers');\n\n//Token Pricing \nconst PRICING_DB = {\n    'gemini': { input: 0.30 / 1000000, output: 2.50 / 1000000 },\n    'llama': { input: 0, output: 0 },\n    'default': { input: 0, output: 0 }\n};\nconst USD_TO_IDR = 16500;\nconst TOKEN_LIMIT_CONFIG = 1000000;\n\nconst metrics = {\n    startTime: Date.now(),\n    tokenUsage: { input: 0, output: 0, total: 0 },\n    llmCalls: 0,\n    errors: []\n};\n\n//Fungsi helper Model Info dan Token usage\n\nfunction getModelInfo(llmObject) {\n    const rawName = llmObject.modelName || llmObject.model || \"Unknown-Model\";\n    const lowerName = rawName.toLowerCase();\n    \n    let pricing = PRICING_DB.default;\n    \n    if (lowerName.includes('flash') || lowerName.includes('gemini')) {\n        pricing = PRICING_DB.gemini;\n    } else if (lowerName.includes('llama') || lowerName.includes('ollama')) {\n        pricing = PRICING_DB.llama;\n    }\n\n    return { name: rawName, pricing: pricing };\n}\n\nfunction trackTokens(response, inputLenEstimate = 0, outputLenEstimate = 0) {\n    let input = 0, output = 0;\n\n    if (response?.response_metadata) {\n        const meta = response.response_metadata;\n        if (meta.usage) { \n            input = meta.usage.prompt_tokens || meta.usage.input_tokens || 0;\n            output = meta.usage.completion_tokens || meta.usage.output_tokens || 0;\n        } else if (meta.prompt_eval_count !== undefined) { \n            input = meta.prompt_eval_count || 0;\n            output = meta.eval_count || 0;\n        }\n    } else {\n        if (inputLenEstimate > 0) input = Math.ceil(inputLenEstimate / 3.5);\n        if (outputLenEstimate > 0) output = Math.ceil(outputLenEstimate / 3.5);\n    }\n\n    metrics.tokenUsage.input += input;\n    metrics.tokenUsage.output += output;\n    metrics.tokenUsage.total += (input + output);\n    metrics.llmCalls++;\n\n    return response;\n}\n\nasync function invokeAndTrack(chain, input, rawInputText = \"\") {\n    let result;\n    try {\n        result = await chain.invoke(input);\n        trackTokens(result, rawInputText.length, JSON.stringify(result).length);\n    } catch (e) {\n        trackTokens(null, rawInputText.length); \n        throw e;\n    }\n    return result;\n}\n\nconst isQuotaError = (error) => {\n    const msg = (error.message || \"\").toLowerCase();\n    return error.status === 429 || error.status === 503 || \n           msg.includes(\"quota\") || msg.includes(\"rate_limit\") || \n           msg.includes(\"overloaded\") || msg.includes(\"resource_exhausted\") ||\n           msg.includes(\"insufficient_quota\");\n};\n\nconst returnError = (message) => {\n    return [[{json:{error: message, metrics: metrics}}], []];\n};\n\n//Iniisiasi tools \nconst workerLLM = (await this.getInputConnectionData('ai_languageModel', 0))?.[0];\nconst synthesizerLLM = (await this.getInputConnectionData('ai_languageModel', 1))?.[0];\nconst fallbackLLM = (await this.getInputConnectionData('ai_languageModel', 2))?.[0];\n\nif (!workerLLM || !synthesizerLLM) return returnError(\"Model LLM utama tidak terhubung!\");\n\nlet activeModel = getModelInfo(workerLLM);\nlet fallbackNotification = \"\"; \n\n// --- DATA EXTRACTION (DATES & USER) ---\nlet analysisPeriod = \"Bulan Ini\";\nlet startDate = null;\nlet endDate = null;\nlet reportUser = \"User\";\nlet capturedChatId = null;\n\ntry {\n    try {\n        const extractorNode = $('Information Extractor').first();\n        if (extractorNode && extractorNode.json && extractorNode.json.output) {\n            startDate = extractorNode.json.output.start_date;\n            endDate = extractorNode.json.output.end_date;\n        }\n    } catch (e) {\n        const inputItems = this.getInputData();\n        for (const item of inputItems) {\n            if (item.json?.start_date && item.json?.end_date) {\n                startDate = item.json.start_date;\n                endDate = item.json.end_date;\n                break;\n            }\n        }\n    }\n\n    if (startDate && endDate) {\n        analysisPeriod = `${startDate} s/d ${endDate}`;\n    }\n\n    try {\n        const telegramNode = $('Telegram Trigger Chatbot').first();\n        // Update path sesuai request Anda: item.json.message.chat.first_name\n        if (telegramNode && telegramNode.json && telegramNode.json.message && telegramNode.json.message.chat) {\n            const firstName = telegramNode.json.message.chat.first_name || \"\";\n            const lastName = telegramNode.json.message.chat.last_name || \"\";\n            capturedChatId = telegramNode.json.message.chat.id; \n            \n            reportUser = `${firstName} ${lastName}`.trim();\n            if (!reportUser) reportUser = \"Pelanggan\";\n        }\n    } catch (e) {\n        // console.log(\"Gagal ambil user dari trigger:\", e);\n    }\n\n} catch (err) {\n    console.log(\"Error extracting metadata:\", err);\n}\n\n// Input Porcessing\nconst inputItems = this.getInputData();\nif (!capturedChatId) {\n    capturedChatId = inputItems[0]?.json?.chat_id || inputItems[0]?.json?.message?.chat?.id;\n}\n\nlet workerInputDocument = \"\";\nconst firstItemJson = inputItems[0]?.json || {};\n\nif (firstItemJson.hasOwnProperty('total_reviews') && firstItemJson.hasOwnProperty('by_ota')) {\n    workerInputDocument = JSON.stringify(firstItemJson);\n} else {\n    const rawReviews = inputItems\n        .map(item => {\n            const json = item.json;\n            const txt = json.review_text || json.message || json.text || \"\";\n            return txt.length > 5 ? {\n                source: json.metadata?.ota || \"Unknown\",\n                message: txt,\n                rating: parseFloat(json.metadata?.rating || json.rating || 0)\n            } : null;\n        })\n        .filter(Boolean);\n\n    if (rawReviews.length === 0) return returnError(\"Review valid kosong.\");\n    workerInputDocument = JSON.stringify(rawReviews);\n}\n\n\n// Agent Prompt\n\nconst summarizerPrompt = PromptTemplate.fromTemplate(`\nAnalisis data review hotel berikut (bisa berupa teks review mentah ATAU statistik agregat) dan berikan output JSON dalam Bahasa Indonesia:\n{document}\nFormat JSON yang WAJIB diikuti:\n{{\n  \"executive_summary\": \"1 paragraf performa & isu utama berdasarkan data yang tersedia\",\n  \"overall_trend\": \"1 Paragraf lengkap (max 6 kalimat): perbandingan platform, penyebab rating turun/naik, kesimpulan trend\",\n  \"global_recommendations\": [\"3 rekomendasi strategis\"]\n}}\nCatatan: \n- Jika input adalah statistik angka, interpretasikan angka tersebut menjadi narasi.\n- Setiap rekomendasi harus 1 kalimat singkat dan actionable. \n`);\n\nconst categorizerPrompt = PromptTemplate.fromTemplate(`\nKategorisasi review hotel (SEMUA DALAM BAHASA INDONESIA):\n{document}\nFormat JSON:\n{{\n  \"total_reviews_global\": 0,\n  \"global_sentiment\": \"Positif/Negatif/Campuran\",\n  \"global_rating\": \"X.X/10\",\n  \"platforms\": [\n    {{\n      \"name\": \"Platform\",\n      \"total_reviews\": 0,\n      \"average_rating\": \"X.X/10\",\n      \"sentiment\": \"Positif/Negatif/Campuran\",\n      \"trend_summary_ota\": \"Dinamika sentimen platform\",\n      \"pros\": [\"Pujian/hal positif\"],\n      \"problems\": [\n        {{\"issue\": \"Masalah\", \"frequency\": 0, \"urgency\": \"Mendesak/Tinggi/Sedang/Rendah\"}}\n      ],\n      \"local_recommendations\": [\"3 rekomendasi Aksi perbaikan\"]\n    }}\n  ]\n}}\nRULES:\n- Jika data input adalah STATISTIK (angka), gunakan data tersebut untuk mengisi rating dan jumlah review.\n- Jika data input tidak memiliki teks kualitatif (pros/cons), isi pros/problems dengan kesimpulan umum dari rating yang ada.\n- Jika tidak ada pros: [\"Tidak ada hal positif signifikan\"]\n- Jika tidak ada problems: [{{\"issue\": \"Tidak ada keluhan spesifik\", \"frequency\": 0, \"urgency\": \"Aman\"}}]\n`);\n\nconst synthesizerPrompt = PromptTemplate.fromTemplate(`\nKamu RoboAI, asisten analisis hotel. Buat laporan dalam HTML untuk Telegram.\nDATA:\nUser Name: {user_name}\nPeriod: {period}\nSummary: {summary}\nStats: {stats}\n\nOUTPUT FORMAT (WAJIB HTML, gunakan <b> untuk bold. JANGAN gunakan tag <p> atau <br>, gunakan Enter biasa):\n\n<<<TELEGRAM_START>>>\nHalo <b>{user_name}</b>! Berikut laporan performa review hotel Anda:\n\n<b>Laporan Performa Ulasan Hotel</b>\n\n<b>1. Periode:</b> {period}\n\n<b>2. Rangkuman:</b>\n[executive_summary dari Summary]\n\n<b>3. Sentimen & Rating Global:</b>\nSentimen: [global_sentiment] | Rating: [global_rating]\n\n<b>4. Analisis Per Platform:</b>\n[LOOP setiap platform:]\n\n<b>Platform: [name]</b>\nReview: [total_reviews] | Rating: [average_rating] | Sentimen: [sentiment]\n- <b>Positif:</b> [gabungkan pros jadi narasi]\n- <b>Masalah:</b>\n  - [issue] ([frequency]x) - [urgency]\n\n<b>5. Rekomendasi Strategis:</b>\n[list global_recommendations dengan dash]\n<<<TELEGRAM_END>>>\n\n<<<REPORT_START>>>\n[Markdown format lengkap untuk PDF - sama seperti Telegram tapi lebih detail]\n<<<REPORT_END>>>\n`);\n\n// Eksekusi Prompt\nlet summaryResult, categoryResult;\nconst inputPayload = { document: workerInputDocument };\n\nconst createAnalysisChains = (model) => ({\n    summarizerChain: RunnableSequence.from([summarizerPrompt, model, new JsonOutputParser()]),\n    categorizerChain: RunnableSequence.from([categorizerPrompt, model, new JsonOutputParser()])\n});\n\ntry {\n    const chains = createAnalysisChains(workerLLM);\n    \n    const [summary, category] = await Promise.all([\n        invokeAndTrack(chains.summarizerChain, inputPayload, workerInputDocument),\n        invokeAndTrack(chains.categorizerChain, inputPayload, workerInputDocument)\n    ]);\n    \n    summaryResult = summary;\n    categoryResult = category;\n\n} catch (error) {\n    if (isQuotaError(error) && fallbackLLM) {\n        const failedModelName = activeModel.name;\n        activeModel = getModelInfo(fallbackLLM); \n        \n        fallbackNotification = `‚ö†Ô∏è <b>PERINGATAN KUOTA API</b>\\n` + \n                               `Kuota token model <b>${failedModelName}</b> telah habis/limit.\\n` +\n                               `üîÑ Sistem beralih otomatis ke model cadangan: <b>${activeModel.name}</b>.\\n\\n`;\n\n        try {\n            const fallbackChains = createAnalysisChains(fallbackLLM);\n            const [summary, category] = await Promise.all([\n                invokeAndTrack(fallbackChains.summarizerChain, inputPayload, workerInputDocument),\n                invokeAndTrack(fallbackChains.categorizerChain, inputPayload, workerInputDocument)\n            ]);\n            \n            summaryResult = summary;\n            categoryResult = category;\n            \n        } catch (fbError) {\n            return returnError(`Fallback gagal: ${fbError.message}`);\n        }\n    } else {\n        return returnError(`Analisis gagal: ${error.message}`);\n    }\n}\n\n// Memisahkan output jadi 2 (rangkuman dan report)\nlet finalTelegramMessage, finalFullReport;\n\ntry {\n    const synthChain = RunnableSequence.from([synthesizerPrompt, synthesizerLLM, new StringOutputParser()]);\n    \n    const result = await synthChain.invoke({\n        user_name: reportUser, \n        period: analysisPeriod,\n        summary: JSON.stringify(summaryResult),\n        stats: JSON.stringify(categoryResult)\n    });\n    \n    const synthInputString = JSON.stringify(summaryResult) + JSON.stringify(categoryResult);\n    trackTokens(null, synthInputString.length, result.length); \n\n    const resultText = result;\n    \n    const telegramMatch = resultText.match(/<<<TELEGRAM_START>>>([\\s\\S]*?)<<<TELEGRAM_END>>>/);\n    const reportMatch = resultText.match(/<<<REPORT_START>>>([\\s\\S]*?)<<<REPORT_END>>>/);\n    \n    finalTelegramMessage = telegramMatch ? telegramMatch[1].trim() : resultText;\n    finalFullReport = reportMatch ? reportMatch[1].trim() : finalTelegramMessage;\n\n    if (fallbackNotification) {\n        finalTelegramMessage = fallbackNotification + finalTelegramMessage;\n    }\n\n} catch (error) {\n    return returnError(`Sintesis gagal: ${error.message}`);\n}\n\n// Identifikasi output yang dikeluarkan\n\nif (typeof finalTelegramMessage === 'string') {\n    finalTelegramMessage = finalTelegramMessage\n        .replace(/<p>/g, '')\n        .replace(/<\\/p>/g, '\\n');\n}\n\nconst duration = (Date.now() - metrics.startTime) / 1000;\nconst costUsd = (metrics.tokenUsage.input * activeModel.pricing.input) + \n                (metrics.tokenUsage.output * activeModel.pricing.output);\nconst costIdr = costUsd * USD_TO_IDR;\nconst remainingTokens = Math.max(0, TOKEN_LIMIT_CONFIG - metrics.tokenUsage.total); \n\nconst pdfData = {\n    approval_needed: true,\n    date: new Date().toISOString(),\n    requested_by: reportUser, \n    analysis_period: analysisPeriod, \n    start_date: startDate,\n    end_date: endDate,\n    \n    report_content: finalFullReport,\n    raw_stats: {\n        ...categoryResult,\n        executive_summary: summaryResult.executive_summary,\n        overall_trend: summaryResult.overall_trend,\n        global_recommendations: summaryResult.global_recommendations\n    },\n    metrics: {\n        model_used: activeModel.name,\n        total_tokens: metrics.tokenUsage.total,\n        remaining_allocation: remainingTokens, \n        cost_usd: costUsd\n    }\n};\n\nreturn [\n    [{\n        json: { \n            type: \"chat_response\", \n            response: finalTelegramMessage,\n            chat_id: capturedChatId,\n            metrics: {\n                model_used: activeModel.name, \n                response_time: duration.toFixed(2) + 's',\n                estimated_cost: `Rp ${Math.ceil(costIdr)}`,\n                token_breakdown: metrics.tokenUsage,\n                remaining_tokens: remainingTokens, \n                fallback_triggered: !!fallbackNotification \n            }\n        }\n    }],\n    [{ \n        json: pdfData \n    }]\n];"
          }
        },
        "inputs": {
          "input": [
            {
              "type": "main"
            },
            {
              "type": "ai_languageModel"
            },
            {
              "type": "ai_languageModel"
            },
            {
              "type": "ai_languageModel"
            },
            {
              "type": "ai_memory"
            }
          ]
        },
        "outputs": {
          "output": [
            {
              "type": "main"
            },
            {
              "type": "main"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.code",
      "typeVersion": 1,
      "position": [
        -2160,
        -1472
      ],
      "id": "c311d912-df00-4a80-aa81-2001a3fa2635",
      "name": "Review Analysis1"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Trigger Chatbot').first().json.message.chat.id }}"
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -1984,
        -1040
      ],
      "id": "3892d198-eeab-40b5-965d-660f78b220b0",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "6Wmt8YnExFDqKOII",
          "name": "Postgres account 2"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger Chatbot').first().json.message.chat.id }}",
        "text": "={{ $json.text }}",
        "additionalFields": {
          "appendAttribution": "={{ false }}",
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2800,
        -1856
      ],
      "id": "c6838505-e4c1-4eea-8f58-c5dec58ef46e",
      "name": "Send a text message4",
      "webhookId": "f2faa3ea-c04e-40e3-a70c-071cc94e7b97",
      "alwaysOutputData": false,
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "sendAndWait",
        "chatId": "={{ $('Telegram Trigger Chatbot').first().json.message.chat.id }}",
        "message": "=Untuk keperluan dokumentasi atau rapat, saya dapat membuat laporan lengkap dalam format PDF. Apakah Anda menginginkannya?",
        "approvalOptions": {
          "values": {
            "approvalType": "double",
            "approveLabel": "‚úÖ Ya",
            "disapproveLabel": "‚ùå Tidak"
          }
        },
        "options": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1376,
        -1632
      ],
      "id": "0e4e35a3-4485-4acd-b85b-be91dae6b93f",
      "name": "Send a text message15",
      "webhookId": "198988f1-a9ba-48b6-ae9b-7d8b1c975318",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4da6c35b-3c2a-415f-8b73-50d241780ec1",
              "leftValue": "={{ $json.data.approved }}",
              "rightValue": "Setuju",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1216,
        -1632
      ],
      "id": "115c960b-29cb-4e46-b234-056bcccea697",
      "name": "If7"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger Chatbot').first().json.message.chat.id }}",
        "text": "Tentu, Manajer. Saya tidak akan melanjutkan proses pembuatan dokumen PDF.",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1040,
        -1792
      ],
      "id": "4ac53cb9-1663-41b2-a568-d97d325f6dcd",
      "name": "Send a text message21",
      "webhookId": "693159f7-669b-48b1-83cb-4e5ecbd12565",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -832,
        -1472
      ],
      "id": "58ddee23-1857-4f7c-af02-c87bee99e1bb",
      "name": "Merge7"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        -144,
        -1456
      ],
      "id": "c92e719b-17ff-4334-9384-97072236df06",
      "name": "Merge1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        -2048,
        -448
      ],
      "id": "f809a2fa-af73-4d88-896c-6b40990d894d",
      "name": "Google Gemini Chat Model7",
      "credentials": {
        "googlePalmApi": {
          "id": "0Uoi9vQ15TeiYabQ",
          "name": "Google Gemini(PaLM) Api account Chatbot"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Information Extractor').first().json.output.agent }}",
                    "rightValue": "summary",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "bd9bfcae-5dcc-46db-97bb-b4d3a349ffb0"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Summarize Agent"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b8156c07-8272-46c7-a2a3-d8ad011293a9",
                    "leftValue": "={{ $('Information Extractor').first().json.output.agent }}",
                    "rightValue": "qa",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Q&A"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fdc8516f-e541-45da-9334-8f8b30ada651",
                    "leftValue": "={{ $('Information Extractor').first().json.output.agent }}",
                    "rightValue": "no_require_data",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "No Data"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "0b6c8179-af79-46ff-9ffb-01c31628cc26",
                    "leftValue": "={{ $('Information Extractor').first().json.output.agent }}",
                    "rightValue": "stats",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "stats"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "65dfa9b3-974f-4736-8471-fe6af910b192",
                    "leftValue": "={{ $('Information Extractor').first().json.output.agent }}",
                    "rightValue": "out_of_topic",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "out of topic"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -2800,
        -976
      ],
      "id": "c8d2485f-9796-49f8-ab70-c29fd1d70c13",
      "name": "Switch - Summarize or Qna",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.chat.id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.message_id }}",
        "text": "=üòî Maaf {{ $('Telegram Trigger Chatbot').item.json.message.from.first_name }}, saya adalah <b>RoboAI</b> yang didesain khusus untuk menganalisis performa dan ulasan hotel sehingga tidak dapat menjawab pertanyaan anda.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2080,
        32
      ],
      "id": "f825d014-f79c-471d-ae44-4217e808de5a",
      "name": "Edit a text message9",
      "webhookId": "4a32a373-53e2-4c6a-9625-58d1b63f0dce",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://ujijqilperkjeyinrkwm.supabase.co/rest/v1/rpc/get_all_reviews_by_date",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "p_user_id",
              "value": "={{ $('Get Data User - Supabase V').item.json.user_robota.id }}"
            },
            {
              "name": "p_start_date",
              "value": "={{ $('Information Extractor').item.json.output.start_date }}"
            },
            {
              "name": "p_end_date",
              "value": "={{ $('Information Extractor').item.json.output.end_date }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3088,
        -928
      ],
      "id": "3970cfa1-f11b-402f-ab8e-0195893a4283",
      "name": "GET Reviews Data By Date - Supabase",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "xpXypIaDFMnlAjAT",
          "name": "Supabase account v2"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://ujijqilperkjeyinrkwm.supabase.co/rest/v1/rpc/get_review_analytics",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "p_user_id",
              "value": "={{ $('Get Data User - Supabase V').item.json.user_robota.id }}"
            },
            {
              "name": "start_date",
              "value": "={{ $('Information Extractor').item.json.output.start_date }}"
            },
            {
              "name": "end_date",
              "value": "={{ $('Information Extractor').item.json.output.end_date }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -3328,
        -928
      ],
      "id": "ceabee96-599d-4d84-a574-8b84740296c4",
      "name": "GET Data Analytic - Supabase1",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "xpXypIaDFMnlAjAT",
          "name": "Supabase account v2"
        }
      }
    },
    {
      "parameters": {
        "text": "={{ $('Telegram Trigger Chatbot').item.json.message.text }}",
        "schemaType": "fromJson",
        "jsonSchemaExample": "{\n\t\"start_date\": \"2025-06-01\",\n    \"end_date\": \"2025-06-31\",\n\t\"ota\": \"agoda\",\n  \"sentiment\" : \"postive\",\n  \"categories\": \"kebersihan\",\n  \"response\": false,\n  \"require_reviews\": true,\n  \"require_hotel_data\": false,\n  \"out_of_topic\": false,\n  \"agent\": \"summary\"\n}",
        "options": {
          "systemPromptTemplate": "=Anda adalah sistem ekstraksi informasi cerdas untuk \"Robota\" (Dashboard Analisis Hotel). Tugas Anda adalah menganalisis input pengguna dan mengubahnya menjadi format JSON terstruktur.\n\n**Waktu Acuan Saat Ini:** {{$today}}\n\nInstruksi Ekstraksi Data:\n\n1.  **start_date** & **end_date**:\n    -   Format wajib: YYYY-MM-DD.\n    -   Jika pengguna menyebutkan \"hari ini\", \"minggu ini\", atau \"tahun ini\", hitung berdasarkan **Waktu Acuan Saat Ini**.\n    -   **PENTING:** Jika pengguna TIDAK menyebutkan rentang waktu spesifik, asumsikan pengguna ingin melihat data **\"Bulan Ini\"** (tanggal 1 bulan ini sampai tanggal terakhir bulan ini). Perhatikan tahun kabisat untuk Februari.\n\n2.  **ota**:\n    -   Sebutkan satu nama OTA spesifik (contoh: \"agoda\", \"booking\", \"traveloka\").\n    -   Jika menyebutkan lebih dari satu atau tidak spesifik, isi dengan \"all\".\n\n3.  **sentiment**:\n    -   Isi dengan \"positive\", \"negative\", atau \"neutral\" jika spesifik.\n    -   Jika tidak disebut, isi \"all\".\n\n4.  **categories**:\n    -   Isi dengan topik spesifik (contoh: \"kebersihan\", \"makanan\", \"pelayanan\", \"ac\").\n    -   Jika membahas umum atau banyak hal, isi \"all\".\n\n5.  **response**:\n    -   `true` jika pengguna mencari review yang SUDAH dibalas.\n    -   `false` jika mencari yang BELUM dibalas atau tidak spesifik.\n\n6.  **require_reviews**:\n    -   `true` jika pengguna membutuhkan daftar teks review mentah.\n    -   `false` jika hanya butuh rangkuman/analisis.\n\n7.  **require_hotel_data**:\n    -   `true` jika pengguna bertanya data profil hotel (alamat, bintang, fasilitas).\n    -   `false` untuk analisis review.\n\n8.  **out_of_topic**:\n    -   `true` jika input sama sekali tidak berhubungan dengan hotel atau review.\n    -   `false` jika masih relevan.\n\n9.  **agent** (PILIH SALAH SATU DENGAN TELITI):\n    -   **\"summary\"**:\n        * **KAPAN DIGUNAKAN:** HANYA jika pengguna meminta **Laporan Lengkap**, **Rangkuman Menyeluruh (Executive Summary)**, atau **Overview Performa Hotel** secara global dalam periode tertentu. jika tidak masuk ke dalam beebrapa kategori pertanyaan tersebut, jangan pakai agent ini.\n        * **FOKUS:** Generalis, mencakup semua aspek, helikopter view.\n        * *Contoh:* \"Buatkan laporan bulanan\", \"Berikan rangkuman performa minggu ini\", \"Bagaimana performa hotel secara keseluruhan?\", \"Executive summary bulan Oktober\".\n\n    -   **\"qa\"**:\n        * **KAPAN DIGUNAKAN:** Jika pengguna mengajukan **PERTANYAAN SPESIFIK** atau **EKSPLORASI** tentang topik yang berkaitan dengan performa hotel berdasarkan review pelanggan dalam periode tertentu.\n        * **CAKUPAN LUAS (Tidak hanya masalah):** Termasuk pertanyaan tentang **Pujian/Kelebihan**, **Keluhan/Kekurangan**, **Fakta Fasilitas**, **Alasan**, **Opini Tamu**, atau **Rekomendasi strategis**, **tren pelanggan**, **sebab akibat masalah**, .\n        * *Contoh (Positif):* \"Apa yang paling disukai tamu?\", \"Sebutkan kelebihan hotel ini\", \"Pujian tentang sarapan\".\n        * *Contoh (Negatif/Masalah):* \"Kenapa rating kebersihan turun?\", \"Apa keluhan utama tamu?\".\n        * *Contoh (Eksploratif/Fakta):* \"Bagaimana kondisi kolam renang?\", \"Apa kata tamu tentang lokasi hotel?\", \"Apakah cocok untuk anak-anak?\".\n\n    -   **\"stats\"**:\n        * **KAPAN DIGUNAKAN:** Jika pengguna secara eksplisit meminta **Data Numerik**, **Angka**, **Tabel**, atau **Statistik Murni** tanpa butuh penjelasan naratif panjang.\n        * *Contoh:* \"Berapa jumlah review bulan ini?\", \"Tampilkan rata-rata rating di Agoda\", \"Berapa persen sentimen positif?\", \"Hitung jumlah komplain AC\".\n\n    -   **\"no_require_data\"**:\n        * Jika percakapan bersifat sapaan (halo, selamat pagi, terima kasih) atau obrolan santai yang tidak membutuhkan pengambilan data hotel.\n\n**OUTPUT WAJIB JSON SAJA, TANPA PENJELASAN LAIN:**",
          "batching": {
            "batchSize": 1
          }
        }
      },
      "type": "@n8n/n8n-nodes-langchain.informationExtractor",
      "typeVersion": 1.2,
      "position": [
        -3952,
        -928
      ],
      "id": "735508c4-676e-4a1a-ada7-9a136520252a",
      "name": "Information Extractor"
    },
    {
      "parameters": {
        "jsCode": "// Get the data from the Telegram trigger\nconst data = $json;\n\n// Get the execution ID from the workflow context\nconst executionId = $execution.id;\n\n// You can log it to the console to check\nconsole.log('My Execution ID:', executionId);\n\n// Add the execution ID to your data object\ndata.my_execution_id = executionId;\n\n// Return the data so the next node can use it\nreturn [{ json: data }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -6576,
        -1040
      ],
      "id": "98de339f-d209-4542-83eb-baf55ceb1d3e",
      "name": "Get Execution Id"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger Chatbot').item.json.message.chat.id }}",
        "text": "Silahkan Pilih Jadwal",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "Mingguan",
                    "additionalFields": {
                      "callback_data": "/notifikasi freq:mingguan"
                    }
                  },
                  {
                    "text": "Bulanan",
                    "additionalFields": {
                      "callback_data": "/notifikasi freq:bulanan"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3952,
        -1968
      ],
      "id": "cd3846db-1687-4314-827b-77fafbd707eb",
      "name": "Send Weekly Or Monthly",
      "webhookId": "db881870-957e-47f0-aa5e-a7e36e42c88e",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Telegram Trigger Chatbot').item.json.message.text }}",
                    "rightValue": "=/notifikasi",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "276d5614-c709-4530-8058-99ce42d4ced3"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "notifikasi"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "eeac2a31-fffd-4f35-906a-d9c379755eda",
                    "leftValue": "={{ $('Telegram Trigger Chatbot').item.json.message.text }}",
                    "rightValue": "/logout",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "logout"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "fb6b1455-e6ff-4791-ac6c-0aafd13b284f",
                    "leftValue": "={{ $('Telegram Trigger Chatbot').item.json.message.text }}",
                    "rightValue": "/",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "/"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1afabf5e-ae98-4616-b52d-fd0b472f3173",
                    "leftValue": "={{ $('Telegram Trigger Chatbot').item.json.callback_query.data }}",
                    "rightValue": "/notifikasi",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "/notifikasi callback"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra",
          "renameFallbackOutput": "Flow Utama"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -4976,
        -1248
      ],
      "id": "dd78debf-b3ad-4192-b3fe-b1a9104cc8de",
      "name": "Switch Config"
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $json.result.chat.id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.message_id }}",
        "text": "Tidaak ada perintah yang cocok,  Silahkan ulangi",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4496,
        -1504
      ],
      "id": "cb005b81-1664-4794-a0ac-4daa5bf8bbc7",
      "name": "Send a Wrong Command",
      "webhookId": "a107e898-4817-4202-a0f5-a8cfad96dadc",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.chat.id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.message_id }}",
        "text": "‚è≥ Sedang menganalisis review Anda...",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4368,
        -928
      ],
      "id": "7c121b89-bba8-46ac-9f97-22d96cc0ed0f",
      "name": "Edit Message \"Processing Command\" - Telegram1",
      "webhookId": "4a32a373-53e2-4c6a-9625-58d1b63f0dce",
      "credentials": {
        "telegramApi": {
          "id": "MEpuMdZJSpQctM3M",
          "name": "Telegram account- delin"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Send a text \"Login Process\" - Telegram').first().json.result.chat.id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').first().json.result.message_id }}",
        "text": "={{ $json.text }}",
        "additionalFields": {
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1360,
        -736
      ],
      "id": "a2592587-5fb2-41ee-9117-daf678844e87",
      "name": "Edit a text message8",
      "webhookId": "4a32a373-53e2-4c6a-9625-58d1b63f0dce",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Send a text \"Login Process\" - Telegram').first().json.result.chat.id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').first().json.result.message_id }}",
        "text": "={{ $json.text }}",
        "additionalFields": {
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1536,
        -1632
      ],
      "id": "49bb1f74-2ae8-4db3-a2b0-f2fac62efa28",
      "name": "Edit a text message10",
      "webhookId": "4a32a373-53e2-4c6a-9625-58d1b63f0dce",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "operation": "deleteMessage",
        "chatId": "={{ $('Send Message \"Create Document\"').item.json.result.chat.id }}",
        "messageId": "={{ $('Send Message \"Create Document\"').item.json.result.message_id }}"
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        656,
        -1536
      ],
      "id": "e6d9ac47-8b20-4244-98d1-e07a23c5bd22",
      "name": "Delete a chat message",
      "webhookId": "4a32a373-53e2-4c6a-9625-58d1b63f0dce",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger Chatbot').first().json.message.chat.id }}",
        "text": "üìÉ Sedang membuat dokumen yang Anda minta",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1040,
        -1632
      ],
      "id": "63fc14a5-06bb-44d2-901b-1f6361c2b270",
      "name": "Send Message \"Create Document\"",
      "webhookId": "4a32a373-53e2-4c6a-9625-58d1b63f0dce",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "7b6efbde-e5c4-4733-946a-53a69dd9cf8f",
              "leftValue": "={{ $('Telegram Trigger Chatbot').item.json.callback_query.id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -6224,
        -1040
      ],
      "id": "59550520-759f-4cf0-ac10-551cb65c2a68",
      "name": "Is Callback"
    },
    {
      "parameters": {
        "url": "https://ujijqilperkjeyinrkwm.supabase.co/rest/v1/user",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "select",
              "value": "*, user_robota(*)"
            },
            {
              "name": "telegram_chat_id",
              "value": "=eq.{{ $('Telegram Trigger Chatbot').item.json.message.chat.id }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -5984,
        -928
      ],
      "id": "b625fd21-593e-4fd4-92a8-de5beb1fcd15",
      "name": "Get Data User - Supabase V",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "xpXypIaDFMnlAjAT",
          "name": "Supabase account v2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "//Get Data\nconst metricsData = $('q&a1')?.first()?.json?.metrics || {};\n//Footer Metric Output\nconst footer = `\\n\\n<i><b>Sistem menyelesaikan Analisis dengan rincian:</b>\n‚Ä¢ Model: ${metricsData.model_used || 'N/A'}\n‚Ä¢ Respon Time: ${metricsData.response_time || 'N/A'}\n‚Ä¢ Konsumsi Token: ${metricsData.token_breakdown?.total || 'N/A'}\n‚Ä¢ Sisa Token: ${metricsData.remaining_tokens || 'Tidak terbatas'}\n‚Ä¢ Estimasi Cost: ${metricsData.estimated_cost || 'N/A'}</i>`;\n\n//Split text\nconst maxLen = 4000;\nconst longText = $input.first().json.response;\nlet items = [];\n\nif (longText && longText.length > 0) {\n    let currentChunk = '';\n    const paragraphs = longText.split('\\n'); \n    \n    for (const paragraph of paragraphs) {\n        if ((currentChunk + paragraph).length < maxLen) {\n            currentChunk += (currentChunk.length > 0 ? '\\n' : '') + paragraph;\n        } else {\n            if (currentChunk.length > 0) {\n                items.push({ json: { text: currentChunk } });\n            }\n            currentChunk = paragraph;\n            \n            // Handle paragraf yang sangat panjang\n            while (currentChunk.length > maxLen) {\n                items.push({ json: { text: currentChunk.substring(0, maxLen) } });\n                currentChunk = currentChunk.substring(maxLen);\n            }\n        }\n    }\n    \n    // Push sisa chunk terakhir\n    if (currentChunk.length > 0) {\n        items.push({ json: { text: currentChunk } });\n    }\n} else {\n    items.push({ json: { text: \"Agent tidak memberikan output.\" } });\n}\n\n// Menambahkan footer ke chunk terakhir\nif (items.length > 0) {\n    let lastIndex = items.length - 1;\n    let lastText = items[lastIndex].json.text || '';\n    \n    if ((lastText.length + footer.length) < 4090) {\n        items[lastIndex].json.text = lastText + footer; \n    } else {\n        items.push({ json: { text: footer } });\n    }\n}\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1712,
        -736
      ],
      "id": "a389fa0f-8889-4d00-ae59-2ba3fe90d578",
      "name": "Code in JavaScript4"
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $json.result.chat.id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.message_id }}",
        "replyMarkup": "inlineKeyboard",
        "text": "Silahkan Pilih Jadwal Mingguan",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "Senin",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:weekly|monday"
                    }
                  },
                  {
                    "text": "Selasa",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:weekly|tuesday"
                    }
                  },
                  {
                    "text": "Rabu",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:weekly|wednesday"
                    }
                  },
                  {
                    "text": "Kamis",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:weekly|thursday"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Jumat",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:weekly|friday"
                    }
                  },
                  {
                    "text": "Sabtu",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:weekly|saturday"
                    }
                  },
                  {
                    "text": "Minggu",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:weekly|sunday"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3520,
        -1776
      ],
      "id": "78ff135c-2ba4-4544-8fc2-3c3fc8a073be",
      "name": "Send Weekly",
      "webhookId": "db881870-957e-47f0-aa5e-a7e36e42c88e",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $json.result.chat.id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.message_id }}",
        "replyMarkup": "inlineKeyboard",
        "text": "Silahkan Pilih Waktu Terbaik anda ‚è∞",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "00:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|0"
                    }
                  },
                  {
                    "text": "01:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{$('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16)}}|1"
                    }
                  },
                  {
                    "text": "02:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{$('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16)}}|2"
                    }
                  },
                  {
                    "text": "03:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|3"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "04:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|4"
                    }
                  },
                  {
                    "text": "05:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|5"
                    }
                  },
                  {
                    "text": "06:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|6"
                    }
                  },
                  {
                    "text": "07:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|7"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "08:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|8"
                    }
                  },
                  {
                    "text": "09:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|9"
                    }
                  },
                  {
                    "text": "10:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|10"
                    }
                  },
                  {
                    "text": "11:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|11"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "12:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|12"
                    }
                  },
                  {
                    "text": "13:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|13"
                    }
                  },
                  {
                    "text": "14:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|14"
                    }
                  },
                  {
                    "text": "15:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|15"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "16:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|16"
                    }
                  },
                  {
                    "text": "17:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|17"
                    }
                  },
                  {
                    "text": "18:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|18"
                    }
                  },
                  {
                    "text": "19:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|19"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "20:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|20"
                    }
                  },
                  {
                    "text": "21:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|21"
                    }
                  },
                  {
                    "text": "22:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|22"
                    }
                  },
                  {
                    "text": "23:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|23"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3520,
        -1376
      ],
      "id": "e46df36c-247b-4434-aa4d-243901e5854a",
      "name": "Send Time - 6 rows",
      "webhookId": "db881870-957e-47f0-aa5e-a7e36e42c88e",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Telegram Trigger Chatbot').item.json.callback_query.data }}",
                    "rightValue": "/notifikasi freq:mingguan",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "b4e68a53-e035-4ed7-9cbb-cab98091777f"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "freq:mingguan"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "1431130b-2582-4515-beb7-3d0b613319ef",
                    "leftValue": "={{ $('Telegram Trigger Chatbot').item.json.callback_query.data }}",
                    "rightValue": "/notifikasi freq:bulanan",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "freq:bulanan"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6ba950b6-9ca9-4bde-8969-bce9e53e53f1",
                    "leftValue": "={{ $('Telegram Trigger Chatbot').item.json.callback_query.data }}",
                    "rightValue": "/notifikasi day:",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "choose time"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "ef4e510f-dd95-4fb8-90a9-bb647ca0222e",
                    "leftValue": "={{ $('Telegram Trigger Chatbot').item.json.callback_query.data }}",
                    "rightValue": "/notifikasi save:",
                    "operator": {
                      "type": "string",
                      "operation": "startsWith"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "save"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.3,
      "position": [
        -4224,
        -1472
      ],
      "id": "bd367339-fa9c-447b-9ef4-013b05cafcf4",
      "name": "Switch2"
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $json.result.chat.id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.message_id }}",
        "replyMarkup": "inlineKeyboard",
        "text": "Silahkan Pilih Jadwal Bulanan üóì",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "1",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|1"
                    }
                  },
                  {
                    "text": "2",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|2"
                    }
                  },
                  {
                    "text": "3",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|3"
                    }
                  },
                  {
                    "text": "4",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|4"
                    }
                  },
                  {
                    "text": "5",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|5"
                    }
                  },
                  {
                    "text": "6",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|6"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "7",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|7"
                    }
                  },
                  {
                    "text": "8",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|8"
                    }
                  },
                  {
                    "text": "9",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|9"
                    }
                  },
                  {
                    "text": "10",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|10"
                    }
                  },
                  {
                    "text": "11",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|11"
                    }
                  },
                  {
                    "text": "12",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|12"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "13",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|13"
                    }
                  },
                  {
                    "text": "14",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|14"
                    }
                  },
                  {
                    "text": "15",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|15"
                    }
                  },
                  {
                    "text": "16",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|16"
                    }
                  },
                  {
                    "text": "17",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|17"
                    }
                  },
                  {
                    "text": "18",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|18"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "19",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|19"
                    }
                  },
                  {
                    "text": "20",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|20"
                    }
                  },
                  {
                    "text": "21",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|21"
                    }
                  },
                  {
                    "text": "22",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|22"
                    }
                  },
                  {
                    "text": "23",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|23"
                    }
                  },
                  {
                    "text": "24",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|24"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "25",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|25"
                    }
                  },
                  {
                    "text": "26",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|26"
                    }
                  },
                  {
                    "text": "27",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|27"
                    }
                  },
                  {
                    "text": "28",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|28"
                    }
                  },
                  {
                    "text": "29",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|29"
                    }
                  },
                  {
                    "text": "30",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|30"
                    }
                  },
                  {
                    "text": "31",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|31"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3520,
        -1584
      ],
      "id": "bb2b6415-2762-4189-9e36-92c012c5217c",
      "name": "Send Monthly",
      "webhookId": "db881870-957e-47f0-aa5e-a7e36e42c88e",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user",
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_chat_id",
              "condition": "eq",
              "keyValue": "={{ $('Telegram Trigger Chatbot').item.json.callback_query.message.chat.id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "day",
              "fieldValue": "={{ $json.schedule_day }}"
            },
            {
              "fieldId": "time",
              "fieldValue": "={{ $json.schedule_hour }}"
            },
            {
              "fieldId": "schedule",
              "fieldValue": "={{ $json.schedule_type }}"
            },
            {
              "fieldId": "date",
              "fieldValue": "=0"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2848,
        -1440
      ],
      "id": "d4392b44-7b79-4a18-b340-9271d6f824f2",
      "name": "Update Schedule Weekly",
      "credentials": {
        "supabaseApi": {
          "id": "xpXypIaDFMnlAjAT",
          "name": "Supabase account v2"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user",
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_chat_id",
              "condition": "eq",
              "keyValue": "={{ $('Telegram Trigger Chatbot').item.json.callback_query.message.chat.id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "schedule",
              "fieldValue": "={{ $json.schedule_type }}"
            },
            {
              "fieldId": "date",
              "fieldValue": "={{ $json.schedule_date }}"
            },
            {
              "fieldId": "time",
              "fieldValue": "={{ $json.schedule_hour }}"
            },
            {
              "fieldId": "day"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2848,
        -1248
      ],
      "id": "aed112ba-02d8-49ef-a1f1-0590976866ac",
      "name": "Update Schedule Monthly",
      "credentials": {
        "supabaseApi": {
          "id": "xpXypIaDFMnlAjAT",
          "name": "Supabase account v2"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $json.telegram_chat_id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.message_id }}",
        "text": "=Selamat, pengaturan notifikasi {{ $json.schedule }} anda telah diperbarui!\n\nJadwal: {{ $json.schedule }} \nDikirim setiap hari: {{ $json.day }}\nPukul: {{ $json.time }}:00",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2640,
        -1440
      ],
      "id": "be4d5ca8-6c4d-4268-83a8-0bd4484e869c",
      "name": "Send a Successfully Set Schedule",
      "webhookId": "25d43c21-3b10-4508-ba1f-d155f3ff9347",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $json.telegram_chat_id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.message_id }}",
        "text": "=Selamat, pengaturan notifikasi {{ $json.schedule }} anda telah diperbarui!\n\nJadwal: {{ $json.schedule }}\nDikirim setiap tanggal: {{ $json.date }}\nPukul: {{ $json.time }}:00",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2640,
        -1248
      ],
      "id": "c1f6a277-70c9-4245-bad0-b58ac877ac76",
      "name": "Send a Successfully Set Schedule1",
      "webhookId": "2c8659bb-34e9-4d58-aec6-3ce6921a5a94",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 1. Ambil data teks (utamakan dari callback_query karena ini tombol)\nconst text = $('Telegram Trigger Chatbot').first().json.callback_query.data;\n\nconst result = {};\n\n// 2. Pecah string berdasarkan SPASI pertama\n// Contoh input: \"/notifikasi save:monthly|7|9\"\n// parts[0] = \"/notifikasi\"\n// parts[1] = \"save:monthly|7|9\"\nconst parts = text.trim().split(' ');\n\n// Cek apakah ada data setelah command utama\nif (parts.length < 2) {\n  result.error = \"Data tidak lengkap.\";\n  return [{ json: result }];\n}\n\nconst payload = parts[1]; // Isinya: \"save:monthly|7|9\"\n\n// 3. Cek parameter 'save:'\n// Jika tidak dimulai dengan 'save:', berarti data belum final/lengkap\nif (!payload.startsWith('save:')) {\n  result.error = \"Perintah bukan 'save'. Menunggu input pengguna...\";\n  result.is_final = false; // Flag untuk memberitahu n8n\n  return [{ json: result }];\n}\n\n// 4. Ambil isi data setelah \"save:\" dan pecah berdasarkan \"|\"\n// .substring(5) membuang tulisan \"save:\" (5 karakter)\n// .split('|') memecah sisanya menjadi array\n// rawParams akan berisi: [\"monthly\", \"7\", \"9\"]\nconst rawParams = payload.substring(5).split('|');\n\n// Validasi jumlah parameter (harus ada 3: tipe, nilai, jam)\nif (rawParams.length !== 3) {\n  result.error = \"Format data tombol rusak. Parameter tidak lengkap.\";\n  return [{ json: result }];\n}\n\nconst type = rawParams[0].toLowerCase();      // \"monthly\" atau \"weekly\"\nconst paramValue = rawParams[1].toLowerCase(); // \"7\" atau \"monday\"\nconst hour = parseInt(rawParams[2], 10);       // \"9\"\n\n// Set tipe jadwal\nresult.schedule_type = type;\n\n// 5. Logika Validasi (Weekly vs Monthly) - SAMA SEPERTI SEBELUMNYA\nif (type === 'weekly') {\n  const validDays = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];\n  \n  if (validDays.includes(paramValue)) {\n    result.schedule_day = paramValue;\n    result.schedule_date = null;\n    result.schedule_hour = hour;\n  } else {\n    result.error = \"Data hari error. Harus nama hari Inggris.\";\n  }\n\n} else if (type === 'monthly') {\n  const dateNum = parseInt(paramValue, 10);\n  \n  if (!isNaN(dateNum) && dateNum >= 1 && dateNum <= 31) {\n    result.schedule_date = dateNum;\n    result.schedule_day = null;\n    result.schedule_hour = hour;\n  } else {\n    result.error = \"Data tanggal error. Harus angka 1-31.\";\n  }\n\n} else {\n  result.error = \"Tipe jadwal tidak dikenali (bukan weekly/monthly).\";\n}\n\n// 6. Validasi Jam\nif (isNaN(hour) || hour < 0 || hour > 23) {\n    result.error = \"Data jam error. Harus angka 0-23.\";\n}\n\n// Kembalikan hasil\nreturn [{ json: result }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -3536,
        -1200
      ],
      "id": "c3405054-6f93-4069-8572-c3ef295aaf53",
      "name": "Prepere Save Schedule"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f254e4d0-31e8-4917-af57-0b46b81e32ee",
              "leftValue": "={{ $json.error }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notExists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3296,
        -1232
      ],
      "id": "ba96fc02-f507-42ca-8ce8-6ccb3d4ac7d3",
      "name": "Is Valid Schedule?"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.schedule_type }}",
                    "rightValue": "weekly",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "21cbeb64-6577-4f0e-ad49-5cca9eca2983"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "mingguan"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "71853b52-ad5d-4a5d-92b2-8a71752b1cce",
                    "leftValue": "={{ $json.schedule_type }}",
                    "rightValue": "monthly",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "bulanan"
            }
          ]
        },
        "options": {
          "allMatchingOutputs": false
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -3072,
        -1344
      ],
      "id": "8d2d163c-2cfe-40d7-8f33-c19cb647c172",
      "name": "Switch Weekly or Monthly",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4da6c35b-3c2a-415f-8b73-50d241780ec1",
              "leftValue": "={{ $('Review Analysis1').item.json.metrics.tokenUsage.input }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1696,
        -1632
      ],
      "id": "e8c3a75b-1ab3-4c55-8855-9128a24e2842",
      "name": "If8"
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.chat.id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.message_id }}",
        "text": "=‚ö†Ô∏è Maaf {{ $('Telegram Trigger Chatbot').item.json.message.from.first_name }}, saya tidak dapat menemukan data ulasan pada periode {{ $('Information Extractor').item.json.output.start_date }} hingga {{ $('Information Extractor').item.json.output.end_date }} untuk menjawab pertanyaan anda.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1536,
        -1792
      ],
      "id": "be205d9f-77e3-4516-a458-7eaf681100bf",
      "name": "Edit a text message11",
      "webhookId": "4a32a373-53e2-4c6a-9625-58d1b63f0dce",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.chat.id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.message_id }}",
        "text": "=‚ö†Ô∏è Maaf {{ $('Telegram Trigger Chatbot').item.json.message.from.first_name }}, saya tidak dapat menemukan data ulasan pada periode {{ $('Information Extractor').item.json.output.start_date }} hingga {{ $('Information Extractor').item.json.output.end_date }} untuk menjawab pertanyaan anda.",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -1360,
        -912
      ],
      "id": "09568565-4508-48db-8648-5878d583ca9b",
      "name": "Edit a text message12",
      "webhookId": "4a32a373-53e2-4c6a-9625-58d1b63f0dce",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "4da6c35b-3c2a-415f-8b73-50d241780ec1",
              "leftValue": "={{ $('q&a1').item.json.metrics.token_usage.input }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1536,
        -736
      ],
      "id": "2542111d-7522-41ac-a47e-c1aad353e64d",
      "name": "If9"
    },
    {
      "parameters": {
        "chatId": "={{ $json.result.chat.id }}",
        "text": "Silahkan Pilih Jadwal Mingguan",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "Senin",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:weekly|monday"
                    }
                  },
                  {
                    "text": "Selasa",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:weekly|tuesday"
                    }
                  },
                  {
                    "text": "Rabu",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:weekly|wednesday"
                    }
                  },
                  {
                    "text": "Kamis",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:weekly|thursday"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "Jumat",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:weekly|friday"
                    }
                  },
                  {
                    "text": "Sabtu",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:weekly|saturday"
                    }
                  },
                  {
                    "text": "Minggu",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:weekly|sunday"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3520,
        -1904
      ],
      "id": "b5f4954e-ecbf-48f1-b68a-5a880604b25c",
      "name": "Send Weekly1",
      "webhookId": "db881870-957e-47f0-aa5e-a7e36e42c88e",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "={{ $json.result.chat.id }}",
        "text": "Silahkan Pilih Jadwal Bulanan üóì",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "1",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|1"
                    }
                  },
                  {
                    "text": "2",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|2"
                    }
                  },
                  {
                    "text": "3",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|3"
                    }
                  },
                  {
                    "text": "4",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|4"
                    }
                  },
                  {
                    "text": "5",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|5"
                    }
                  },
                  {
                    "text": "6",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|6"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "7",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|7"
                    }
                  },
                  {
                    "text": "8",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|8"
                    }
                  },
                  {
                    "text": "9",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|9"
                    }
                  },
                  {
                    "text": "10",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|10"
                    }
                  },
                  {
                    "text": "11",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|11"
                    }
                  },
                  {
                    "text": "12",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|12"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "13",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|13"
                    }
                  },
                  {
                    "text": "14",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|14"
                    }
                  },
                  {
                    "text": "15",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|15"
                    }
                  },
                  {
                    "text": "16",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|16"
                    }
                  },
                  {
                    "text": "17",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|17"
                    }
                  },
                  {
                    "text": "18",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|18"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "19",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|19"
                    }
                  },
                  {
                    "text": "20",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|20"
                    }
                  },
                  {
                    "text": "21",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|21"
                    }
                  },
                  {
                    "text": "22",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|22"
                    }
                  },
                  {
                    "text": "23",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|23"
                    }
                  },
                  {
                    "text": "24",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|24"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "25",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|25"
                    }
                  },
                  {
                    "text": "26",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|26"
                    }
                  },
                  {
                    "text": "27",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|27"
                    }
                  },
                  {
                    "text": "28",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|28"
                    }
                  },
                  {
                    "text": "29",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|29"
                    }
                  },
                  {
                    "text": "30",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|30"
                    }
                  },
                  {
                    "text": "31",
                    "additionalFields": {
                      "callback_data": "/notifikasi day:monthly|31"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3376,
        -1584
      ],
      "id": "136617d2-b798-4a25-87c4-137e496ab74f",
      "name": "Send Monthly1",
      "webhookId": "db881870-957e-47f0-aa5e-a7e36e42c88e",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "={{ $json.result.chat.id }}",
        "text": "Silahkan Pilih Waktu Terbaik anda ‚è∞",
        "replyMarkup": "inlineKeyboard",
        "inlineKeyboard": {
          "rows": [
            {
              "row": {
                "buttons": [
                  {
                    "text": "00:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|0"
                    }
                  },
                  {
                    "text": "01:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{$('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16)}}|1"
                    }
                  },
                  {
                    "text": "02:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{$('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16)}}|2"
                    }
                  },
                  {
                    "text": "03:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|3"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "04:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|4"
                    }
                  },
                  {
                    "text": "05:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|5"
                    }
                  },
                  {
                    "text": "06:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|6"
                    }
                  },
                  {
                    "text": "07:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|7"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "08:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|8"
                    }
                  },
                  {
                    "text": "09:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|9"
                    }
                  },
                  {
                    "text": "10:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|10"
                    }
                  },
                  {
                    "text": "11:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|11"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "12:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|12"
                    }
                  },
                  {
                    "text": "13:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|13"
                    }
                  },
                  {
                    "text": "14:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|14"
                    }
                  },
                  {
                    "text": "15:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|15"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "16:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|16"
                    }
                  },
                  {
                    "text": "17:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|17"
                    }
                  },
                  {
                    "text": "18:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|18"
                    }
                  },
                  {
                    "text": "19:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|19"
                    }
                  }
                ]
              }
            },
            {
              "row": {
                "buttons": [
                  {
                    "text": "20:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|20"
                    }
                  },
                  {
                    "text": "21:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|21"
                    }
                  },
                  {
                    "text": "22:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|22"
                    }
                  },
                  {
                    "text": "23:00",
                    "additionalFields": {
                      "callback_data": "=/notifikasi save:{{ $('Telegram Trigger Chatbot').item.json.callback_query.data.slice(16) }}|23"
                    }
                  }
                ]
              }
            }
          ]
        },
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3376,
        -1376
      ],
      "id": "30194e60-f8bf-4b46-8734-b40c50f66892",
      "name": "Send Time - 6 rows1",
      "webhookId": "db881870-957e-47f0-aa5e-a7e36e42c88e",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "chatId": "={{ $json.telegram_chat_id }}",
        "text": "=Selamat, pengaturan notifikasi {{ $json.schedule }} anda telah diperbarui!\n\nJadwal: {{ $json.schedule }} \nDikirim setiap hari: {{ $json.day }}\nPukul: {{ $json.time }}:00",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -2992,
        -1856
      ],
      "id": "192c0964-2f12-40b4-b484-f7373a89b508",
      "name": "Send a Successfully Set Schedule2",
      "webhookId": "25d43c21-3b10-4508-ba1f-d155f3ff9347",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "user",
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_chat_id",
              "keyValue": "={{ $('Telegram Trigger Chatbot').item.json.message.chat.id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4848,
        -1504
      ],
      "id": "8465c94d-ec09-4cc1-a53a-fceb696368d8",
      "name": "Get a row",
      "credentials": {
        "supabaseApi": {
          "id": "xpXypIaDFMnlAjAT",
          "name": "Supabase account v2"
        }
      }
    },
    {
      "parameters": {
        "operation": "deleteMessage",
        "chatId": "={{ $('Telegram Trigger Chatbot').item.json.message.chat.id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.message_id }}"
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4160,
        -1728
      ],
      "id": "9978df2a-b868-4fbf-b6e9-021fba2cf515",
      "name": "Delete a chat message1",
      "webhookId": "57c4f199-1029-4c5b-978e-500cda180f57",
      "credentials": {
        "telegramApi": {
          "id": "MEpuMdZJSpQctM3M",
          "name": "Telegram account- delin"
        }
      }
    },
    {
      "parameters": {
        "operation": "sendAndWait",
        "chatId": "={{ $('Telegram Trigger Chatbot').item.json.message.chat.id }}",
        "message": "=Jadwal Laporan Rutin Sekarang adalah {{ ($json.schedule || 'Belum Diatur').toString() }}, hari-tanggal: {{ ($json.day || $json.date || '-').toString() }}, jam: {{ ($json.time || '-').toString() + ($json.time ? ':00' : '')}}",
        "approvalOptions": {
          "values": {
            "approvalType": "double",
            "approveLabel": "üóì Ubah Jadwal",
            "disapproveLabel": "‚ùå Tidak"
          }
        },
        "options": {
          "limitWaitTime": {
            "values": {
              "resumeUnit": "minutes"
            }
          },
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4576,
        -1712
      ],
      "id": "5f3c652c-3056-4ce0-b7c8-25eb6a101062",
      "name": "Confirm to Set Schedule",
      "webhookId": "9c46b994-3852-4dcb-8017-80f58cef22a6",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Trigger Chatbot').item.json.message.chat.id }}",
        "text": "Terimakasih atas konfirmasinya",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -3952,
        -1824
      ],
      "id": "1ad46088-739c-40ed-bd08-e67161406abc",
      "name": "Send Weekly Or Monthly1",
      "webhookId": "db881870-957e-47f0-aa5e-a7e36e42c88e",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "fd3ed9d0-4508-4c9a-8466-ceb08f70f4cb",
              "leftValue": "={{ $json.data.approved }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4320,
        -1920
      ],
      "id": "8aca2d06-e8aa-4335-8647-de764cf4ae1f",
      "name": "Set Schedul?"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user",
        "filters": {
          "conditions": [
            {
              "keyName": "telegram_chat_id",
              "condition": "eq",
              "keyValue": "={{ $json.result.chat.id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_robota_id",
              "fieldValue": "={{ null }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -4848,
        -1696
      ],
      "id": "0d1ff16d-6651-4c46-8131-005859f255ca",
      "name": "Logout - Supabase",
      "credentials": {
        "supabaseApi": {
          "id": "xpXypIaDFMnlAjAT",
          "name": "Supabase account v2"
        }
      }
    },
    {
      "parameters": {
        "operation": "editMessageText",
        "chatId": "={{ $json.telegram_chat_id }}",
        "messageId": "={{ $('Send a text \"Login Process\" - Telegram').item.json.result.message_id }}",
        "text": "Anda Sudah Berhasil Logout !!",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4624,
        -1856
      ],
      "id": "bec06183-cfab-41c6-af72-640f80df6ec7",
      "name": "Send Sucess Logout",
      "webhookId": "07eb552d-ae79-4500-8ea3-196320112358",
      "credentials": {
        "telegramApi": {
          "id": "smQor6MYv7kBCurZ",
          "name": "Telegram - RoboAI"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "Login Via Web1": {
      "main": [
        [
          {
            "node": "API Robota - Login User1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Information Extractor1": {
      "main": [
        [
          {
            "node": "Switch For Relevant Data1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model6": {
      "ai_languageModel": [
        [
          {
            "node": "Information Extractor1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger Chatbot1": {
      "main": [
        [
          {
            "node": "Switch Config1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Get Data User1": {
      "main": [
        [
          {
            "node": "User Data in Database?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Data in Database?1": {
      "main": [
        [
          {
            "node": "Edit a text message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Supabase - Create User1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "is Login Robota Account?1": {
      "main": [
        [
          {
            "node": "Edit a text message1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Messages - Login First1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Create User1": {
      "main": [
        [
          {
            "node": "Send Messages - Login First1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch For Relevant Data1": {
      "main": [
        [],
        [
          {
            "node": "API Robota - Get Data Reviews2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "No Operation, do nothing1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API Robota - Get Data Reviews2": {
      "main": [
        [],
        [
          {
            "node": "API Robota - Refresh Token (if token expired)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Update a token_api1": {
      "main": [
        [
          {
            "node": "API Robota - Get Data Reviews ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API Robota - Get Data Reviews ": {
      "main": [
        []
      ]
    },
    "API Robota - Login User1": {
      "main": [
        [
          {
            "node": "Supabase - Add a user token_api1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a Message - Failed Login1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "API Robota - Refresh Token (if token expired)1": {
      "main": [
        [
          {
            "node": "Supabase - Update a token_api1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Add a user token_api1": {
      "main": [
        [
          {
            "node": "Send a Message - Login Succesfully1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Config1": {
      "main": [
        [
          {
            "node": "Code5",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a text message11",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If5": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a text message16",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [],
        [
          {
            "node": "Update a row5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update a row5": {
      "main": [
        [
          {
            "node": "Send a text message17",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code5": {
      "main": [
        [
          {
            "node": "If5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a text message": {
      "main": [
        [
          {
            "node": "Supabase - Get Data User1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit a text message": {
      "main": [
        [
          {
            "node": "is Login Robota Account?1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mock data": {
      "main": [
        []
      ]
    },
    "Edit a text message1": {
      "main": [
        [
          {
            "node": "Information Extractor1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When clicking ‚ÄòExecute workflow‚Äô": {
      "main": [
        [
          {
            "node": "Get Data User and Reviews- Supabase v2",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Data User and Reviews- Supabase v",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger one hours": {
      "main": [
        [
          {
            "node": "Supabase API",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Data User and Reviews- Supabase v2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase API": {
      "main": [
        [
          {
            "node": "Time is OK & Weekly",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Time is OK & Weekly": {
      "main": [
        [
          {
            "node": "Subworkflow Get Data Reviews - Weekly",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "SubWorkflow Get Data Reviews",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Subworkflow Get Data Reviews - Weekly": {
      "main": [
        [
          {
            "node": "Edit_Field",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SubWorkflow Get Data Reviews": {
      "main": [
        [
          {
            "node": "Edit_Field6",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase API - Get User with Signed": {
      "main": [
        [
          {
            "node": "Sub Workflow - Get Data Critical Review Today",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sub Workflow - Get Data Critical Review Today": {
      "main": [
        []
      ]
    },
    "Edit_Field6": {
      "main": [
        [
          {
            "node": "Generate Report Notification - Monthly",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit_Field": {
      "main": [
        [
          {
            "node": "Generate Report Notification - Weekly",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Trigger Chatbot": {
      "main": [
        [
          {
            "node": "Get Execution Id",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "User Data in Database?": {
      "main": [
        [
          {
            "node": "Send a text \"Login Process\" - Telegram",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Supabase - Create User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "is Login Robota Account?": {
      "main": [
        [
          {
            "node": "Switch Config",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Messages - Login First",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase - Create User": {
      "main": [
        [
          {
            "node": "Send Messages - Login First",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Data User - Supabase V2": {
      "main": [
        [
          {
            "node": "User Data in Database?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a text \"Login Process\" - Telegram": {
      "main": [
        [
          {
            "node": "is Login Robota Account?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send a \"Processing User Command\" - Telegram": {
      "main": [
        []
      ]
    },
    "Edit Message \"Extract Information\" - Telegram": {
      "main": [
        [
          {
            "node": "Information Extractor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Testing - Get Data Reviews (Notif Urgent) - API Robota": {
      "main": [
        [
          {
            "node": "Transform Data Reviews",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Data User and Reviews- Supabase v2": {
      "main": [
        [
          {
            "node": "Testing - Get Data Reviews (Notif Urgent) - API Robota",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Data Reviews",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Data Reviews": {
      "main": [
        [
          {
            "node": "Compare Datasets",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Transform Data Reviews": {
      "main": [
        [
          {
            "node": "Compare Datasets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compare Datasets": {
      "main": [
        [
          {
            "node": "Create a New Review (Not Embed) - Supabase v2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create a New Review (Not Embed) - Supabase v2": {
      "main": [
        [
          {
            "node": "Is Urgent Review?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get User Tele - Code": {
      "main": [
        [
          {
            "node": "Sent Urgent Review",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Urgent Review?": {
      "main": [
        [
          {
            "node": "Get User Tele - Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Login Via Web": {
      "main": [
        [
          {
            "node": "HTTP Request4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request4": {
      "main": [
        [
          {
            "node": "Upsert Robota Account Data - Supabasev2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a Failed Login",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Reviews Last Years - API Robota": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Get Data Hotel - API Robota": {
      "main": [
        [
          {
            "node": "Merge",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge": {
      "main": [
        [
          {
            "node": "Prepared Text Before Embeding Process",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merged Embeding Result": {
      "main": [
        [
          {
            "node": "Insert Reviews Data - Supabase V",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepared Text Before Embeding Process": {
      "main": [
        [
          {
            "node": "Embedding HuggingFace",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Upsert Robota Account Data - Supabasev2": {
      "main": [
        [
          {
            "node": "Update User Data - Supabase V2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update User Data - Supabase V2": {
      "main": [
        [
          {
            "node": "isEmbedding?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embedding HuggingFace": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "Merged Embeding Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Insert Reviews Data - Supabase V": {
      "main": [
        [
          {
            "node": "Update Status Embeding - Supabase V2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "isEmbedding?": {
      "main": [
        [
          {
            "node": "Send a Successfully Login",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Data Hotel - API Robota",
            "type": "main",
            "index": 0
          },
          {
            "node": "Get Reviews Last Years - API Robota",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Data User and Reviews- Supabase v": {
      "main": [
        [
          {
            "node": "Time is OK & Weekly",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create a row": {
      "main": [
        [
          {
            "node": "Is Callback",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit a Message\"Thinking Process\"1": {
      "main": [
        [
          {
            "node": "GET Data Analytic - Supabase1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model11": {
      "ai_languageModel": [
        [
          {
            "node": "Information Extractor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "If8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ollama Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Review Analysis1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Code2": {
      "main": [
        [
          {
            "node": "Delete a chat message",
            "type": "main",
            "index": 0
          },
          {
            "node": "Send a document1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download file": {
      "main": [
        [
          {
            "node": "Code2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Convert to File": {
      "main": [
        [
          {
            "node": "Set to text/html",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update file": {
      "main": [
        [
          {
            "node": "Download file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set to text/html": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create file from text": {
      "main": [
        [
          {
            "node": "Merge1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Create Report1": {
      "main": [
        [
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          },
          {
            "node": "Create file from text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory9": {
      "ai_memory": [
        [
          {
            "node": "q&a1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Ollama Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "q&a1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "q&a1": {
      "main": [
        [
          {
            "node": "Code in JavaScript4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Review Analysis1",
            "type": "ai_languageModel",
            "index": 2
          },
          {
            "node": "Review Analysis1",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "Review Analysis1": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "Review Analysis1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Send a text message4": {
      "main": [
        []
      ]
    },
    "Send a text message15": {
      "main": [
        [
          {
            "node": "If7",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If7": {
      "main": [
        [
          {
            "node": "Send Message \"Create Document\"",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a text message21",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge7": {
      "main": [
        [
          {
            "node": "Create Report1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge1": {
      "main": [
        [
          {
            "node": "Update file",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model7": {
      "ai_languageModel": [
        [
          {
            "node": "q&a1",
            "type": "ai_languageModel",
            "index": 1
          }
        ]
      ]
    },
    "Switch - Summarize or Qna": {
      "main": [
        [
          {
            "node": "Review Analysis1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "q&a1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit a text message7",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "q&a1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit a text message9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GET Data Analytic - Supabase1": {
      "main": [
        [
          {
            "node": "GET Reviews Data By Date - Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GET Reviews Data By Date - Supabase": {
      "main": [
        [
          {
            "node": "Switch - Summarize or Qna",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Information Extractor": {
      "main": [
        [
          {
            "node": "Edit a Message\"Thinking Process\"1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Execution Id": {
      "main": [
        [
          {
            "node": "Create a row",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Config": {
      "main": [
        [
          {
            "node": "Get a row",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Logout - Supabase",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send a Wrong Command",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Switch2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit Message \"Processing Command\" - Telegram1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Messages - Login First": {
      "main": [
        []
      ]
    },
    "Edit Message \"Processing Command\" - Telegram1": {
      "main": [
        [
          {
            "node": "Edit Message \"Extract Information\" - Telegram",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit a text message10": {
      "main": [
        [
          {
            "node": "Send a text message15",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete a chat message": {
      "main": [
        []
      ]
    },
    "Send Message \"Create Document\"": {
      "main": [
        [
          {
            "node": "Merge7",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Is Callback": {
      "main": [
        [
          {
            "node": "Get Data User - Supabase V2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Get Data User - Supabase V",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Data User - Supabase V": {
      "main": [
        [
          {
            "node": "User Data in Database?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript4": {
      "main": [
        [
          {
            "node": "If9",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch2": {
      "main": [
        [
          {
            "node": "Send Weekly",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Monthly",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Time - 6 rows",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prepere Save Schedule",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Schedule Weekly": {
      "main": [
        [
          {
            "node": "Send a Successfully Set Schedule",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Schedule Monthly": {
      "main": [
        [
          {
            "node": "Send a Successfully Set Schedule1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepere Save Schedule": {
      "main": [
        [
          {
            "node": "Is Valid Schedule?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Valid Schedule?": {
      "main": [
        [
          {
            "node": "Switch Weekly or Monthly",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch Weekly or Monthly": {
      "main": [
        [
          {
            "node": "Update Schedule Weekly",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Schedule Monthly",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If8": {
      "main": [
        [
          {
            "node": "Edit a text message11",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit a text message10",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If9": {
      "main": [
        [
          {
            "node": "Edit a text message12",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Edit a text message8",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get a row": {
      "main": [
        [
          {
            "node": "Confirm to Set Schedule",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Confirm to Set Schedule": {
      "main": [
        [
          {
            "node": "Delete a chat message1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Set Schedul?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Schedul?": {
      "main": [
        [
          {
            "node": "Send Weekly Or Monthly",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Weekly Or Monthly1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Logout - Supabase": {
      "main": [
        [
          {
            "node": "Send Sucess Logout",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "availableInMCP": false,
    "errorWorkflow": "A0QaMdQheut9p17E"
  },
  "versionId": "994eed6c-5527-4a59-ba8c-47fa3586e798",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "728021f9561ff71aa4adc28d9ac28aa27665a6db42608a7faa73d0c01e341e03"
  },
  "id": "HSQHofsXH9m43KxX",
  "tags": [
    {
      "updatedAt": "2025-11-28T03:40:41.244Z",
      "createdAt": "2025-11-28T03:40:41.244Z",
      "id": "0PXsWRJvlfpIZBzT",
      "name": "workflow - pmld"
    }
  ]
}